<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت رستوران</title>
    <meta name="description" content="سیستم جامع مدیریت رستوران برای سازماندهی غذاها، مواد اولیه و موجودی.">
    <meta name="keywords" content="مدیریت رستوران، غذا، مواد اولیه، موجودی، آشپزی">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.0.6/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@majidh1/jalalidatepicker/dist/jalalidatepicker.min.js"></script>
    <script src="https://unpkg.com/jalali-moment/dist/jalali-moment.browser.js"></script>


    <meta name="csrf-token" content="{{ csrf_token }}">

    <style>

        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }

        * {
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            direction: rtl;
            overflow-x: hidden;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #eee;
            flex-shrink: 0;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: #555;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
        }

        .sidebar-menu a i {
            margin-left: 10px;
            font-size: 18px;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: #e8f5e9;
            color: #4CAF50;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            background-color: #f4f6f9;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            color: #333;
        }

        .header .add-button {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .header .add-button:hover {
            background-color: #45a049;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-left: 15px;
            color: #fff;
        }

        .card-icon.purple { background-color: #9c27b0; }
        .card-icon.blue { background-color: #2196f3; }
        .card-icon.green { background-color: #4CAF50; }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #555;
        }

        .card-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-top: 10px;
        }

        .table-container {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
            min-width: 600px;
        }

        th, td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        th {
            background-color: #f8f8f8;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        td {
            color: #666;
            font-size: 15px;
        }

        .table-actions button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 8px;
            font-size: 18px;
            transition: color 0.2s;
        }

        .table-actions .edit-btn { color: #2196f3; }
        .table-actions .delete-btn { color: #f44336; }

        .table-actions .edit-btn:hover { color: #1976d2; }
        .table-actions .delete-btn:hover { color: #d32f2f; }

        .tag {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-left: 5px;
        }

        .tag.iranian { background-color: #e8f5e9; color: #4CAF50; }
        .tag.stew { background-color: #ffe0b2; color: #fb8c00; }
        .tag.protein { background-color: #bbdefb; color: #2196f3; }
        .tag.grains { background-color: #c8e6c9; color: #4CAF50; }
        .tag.oil { background-color: #fff9c4; color: #ffeb3b; }
        .tag.vegetables { background-color: #dcedc8; color: #8bc34a; }
        .tag.spices { background-color: #f8bbd0; color: #e91e63; }
        .tag.dairy { background-color: #e0f2f7; color: #00bcd4; } /* New */
        .tag.meat { background-color: #ffcdd2; color: #f44336; } /* New */
        .tag.seafood { background-color: #b2ebf2; color: #00bcd4; } /* New */
        .tag.fruit { background-color: #f0f4c3; color: #cddc39; } /* New */
        .tag.dessert { background-color: #f3e5f5; color: #9c27b0; } /* New */
        .tag.drink { background-color: #e1f5fe; color: #2196f3; } /* New */
        .tag.other { background-color: #eceff1; color: #607d8b; } /* New */
        .tag.main { background-color: #e8f5e9; color: #4CAF50; }
        .tag.appetizer { background-color: #ffe0b2; color: #fb8c00; }
        .tag.dessert-tag { background-color: #f3e5f5; color: #9c27b0; }


        .food-sizes span {
            display: inline-block;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin-left: 5px;
            font-size: 13px;
            color: #777;
            white-space: nowrap;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .chart-card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
        }

        .material-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .material-item .color-box {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .material-item .quantity {
            font-weight: bold;
            margin-left: 5px;
            color: #4CAF50;
            white-space: nowrap;
        }

        .material-item .description {
            color: #666;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            height: 10px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }

        .progress-bar.green { background-color: #4CAF50; }
        .progress-bar.orange { background-color: #ff9800; }
        .progress-bar.red { background-color: #f44336; }

        .progress-text {
            font-size: 14px;
            color: #555;
            margin-top: 10px;
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .form-group input[type="text"].formatted-price {
            text-align: left;
            direction: ltr;
        }
        .form-group .price-display {
            font-size: 14px;
            color: #777;
            margin-top: 5px;
            display: block;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .form-group.inline-group {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .form-group.inline-group > div {
            flex: 1;
            min-width: 200px;
        }

        .form-group.inline-group label {
            margin-bottom: 5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 10px;
            width: 20px;
            height: 20px;
            transform: scale(1.2);
            accent-color: #4CAF50;
            cursor: pointer;
        }

        .add-material-btn {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
            margin-bottom: 20px;
            white-space: nowrap;
        }

        .add-material-btn:hover {
            background-color: #45a049;
        }

        .raw-materials-list .material-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
            flex-wrap: wrap;
        }

        .raw-materials-list .material-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .raw-materials-list .material-row > div {
            flex: 1;
            min-width: 120px;
        }
        .raw-materials-list .material-row > div:first-child {
             min-width: 150px;
        }


        .raw-materials-list .material-row .actions {
            flex: 0 0 40px;
            text-align: center;
            align-self: center;
        }

        .raw-materials-list .material-row input,
        .raw-materials-list .material-row select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            box-sizing: border-box;
        }

        .raw-materials-list .material-row .delete-material-btn {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }

        .raw-materials-list .material-row .delete-material-btn:hover {
            color: #d32f2f;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .form-actions button {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .form-actions .save-btn {
            background-color: #4CAF50;
            color: #fff;
            border: none;
        }

        .form-actions .save-btn:hover {
            background-color: #45a049;
        }

        .form-actions .cancel-btn {
            background-color: #f0f0f0;
            color: #666;
            border: 1px solid #ccc;
        }

        .form-actions .cancel-btn:hover {
            background-color: #e0e0e0;
        }

        .food-item-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .food-item-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 20px;
        }
        .food-item-card .details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
            color: #777;
        }
        .food-item-card .details span {
            display: flex;
            align-items: center;
        }
        .food-item-card .details i {
            margin-left: 5px;
            color: #555;
        }
        .food-item-card .main-materials {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .food-item-card .main-materials span {
            display: inline-block;
            background-color: #e3f2fd;
            color: #1e88e5;
            padding: 6px 12px;
            border-radius: 6px;
            margin-left: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        .food-item-card .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
        }
        .food-item-card .card-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .food-item-card .card-actions .edit-btn { color: #2196f3; }
        .food-item-card .card-actions .delete-btn { color: #f44336; }
        .food-item-card .card-actions .edit-btn:hover { background-color: #e3f2fd; }
        .food-item-card .card-actions .delete-btn:hover { background-color: #ffebee; }

        .search-filter-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            background-color: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            flex-wrap: wrap;
        }

        .search-filter-bar .search-input {
            flex-grow: 1;
            position: relative;
            min-width: 180px;
        }

        .search-filter-bar .search-input input {
            width: 100%;
            padding: 10px 15px;
            padding-right: 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
        }

        .search-filter-bar .search-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .search-filter-bar .filter-dropdown select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23888888" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: left 10px center;
            padding-left: 35px;
            min-width: 150px;
            box-sizing: border-box;
        }

        .search-filter-bar .filter-dropdown {
            position: relative;
        }

        .search-filter-bar .add-button {
            padding: 10px 15px;
            font-size: 14px;
            gap: 5px;
            order: -1;
        }

        .raw-material-item-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .raw-material-item-card .info {
            flex-grow: 1;
            margin-bottom: 10px;
        }
        .raw-material-item-card h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        .raw-material-item-card .details {
            font-size: 14px;
            color: #777;
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px 10px;
        }
        .raw-material-item-card .details span {
            white-space: nowrap;
        }
        .raw-material-item-card .actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .raw-material-item-card .actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            margin-left: 0;
            transition: color 0.2s;
            padding: 5px;
        }
        .raw-material-item-card .actions .edit-btn { color: #2196f3; }
        .raw-material-item-card .actions .delete-btn { color: #f44336; }
        .raw-material-item-card .actions .edit-btn:hover { color: #1976d2; }
        .raw-material-item-card .actions .delete-btn:hover { color: #d32f2f; }


        .user-profile {
            display: flex;
            flex-direction: column; /* Changed to column */
            align-items: center; /* Centered items */
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #eee;
            gap: 15px;
        }

        .user-profile .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #c8e6c9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #4CAF50;
            flex-shrink: 0;
        }

        .user-profile .user-info {
            flex-grow: 1;
            text-align: center; /* Centered text */
        }

        .user-profile .user-info .name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .user-profile .user-info .role {
            font-size: 13px;
            color: #777;
            margin-bottom: 10px; /* Added margin for button */
        }

        .user-profile .logout-button {
            background-color: #f44336;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .user-profile .logout-button:hover {
            background-color: #d32f2f;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 15px;
                flex-direction: row; /* Main layout for sidebar */
                justify-content: space-between; /* Space out items */
                align-items: center; /* Align items vertically */
                border-left: none;
                border-bottom: 1px solid #eee;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .sidebar-header {
                display: none; /* Hide header on small screens */
            }
            .sidebar-menu ul {
                display: flex;
                flex-wrap: nowrap;
                justify-content: flex-start;
                gap: 5px;
                padding-bottom: 0; /* No padding needed here */
            }
            .sidebar-menu li {
                margin-bottom: 0;
                flex-shrink: 0;
            }
            .sidebar-menu a {
                padding: 10px 12px;
                font-size: 14px;
            }
            .sidebar-menu a i {
                font-size: 16px;
            }
            .user-profile {
                display: flex; /* Show user profile on small screens now */
                flex-direction: row; /* Row layout for user profile */
                align-items: center;
                padding-top: 0;
                border-top: none;
                gap: 15px;
                margin-top: 0; /* Remove auto margin */
            }
            .user-profile .avatar {
                margin-right: 0;
            }
            .user-profile .user-info {
                text-align: left; /* Align text left */
                margin-bottom: 0;
            }
            .user-profile .logout-button {
                margin-right: auto; /* Push button to the right */
            }
            .main-content {
                padding: 20px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .cards-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .header h1 {
                font-size: 24px;
            }
            .header .add-button {
                width: 100%;
                justify-content: center;
                padding: 10px 15px;
            }

            .form-container {
                padding: 15px;
            }
            .form-group.inline-group {
                flex-direction: column;
                gap: 15px;
            }
            .raw-materials-list .material-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding-bottom: 15px;
            }
            .raw-materials-list .material-row > div {
                width: 100%;
                min-width: unset;
            }
            .raw-materials-list .material-row .actions {
                text-align: right;
                width: 100%;
            }
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            .form-actions button {
                width: 100%;
            }

            .search-filter-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 10px 15px;
            }
            .search-filter-bar .search-input {
                width: 100%;
                min-width: unset;
            }
            .search-filter-bar .search-input input {
                 padding-right: 15px;
                 padding-left: 15px;
            }
            .search-filter-bar .search-input i {
                left: unset;
                right: 15px;
            }
            .search-filter-bar .filter-dropdown {
                width: 100%;
                min-width: unset;
            }
            .search-filter-bar .filter-dropdown select {
                width: 100%;
                padding-left: 15px;
                background-position: left 15px center;
            }
            .search-filter-bar .add-button {
                width: 100%;
                order: -1;
                justify-content: center;
            }

            .raw-material-item-card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 20px;
            }
            .raw-material-item-card .info {
                margin-bottom: 0;
            }
            .raw-material-item-card .actions {
                justify-content: flex-end;
                width: 100%;
            }
            .raw-material-item-card .details {
                flex-direction: column;
                gap: 5px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }
            .cards-container {
                grid-template-columns: 1fr;
            }
            .card {
                padding: 20px;
            }
            .card-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                margin-bottom: 10px;
            }
            .card-icon {
                margin-left: 0;
                margin-bottom: 10px;
            }
            .table-container {
                padding: 15px;
            }
            th, td {
                padding: 10px;
                font-size: 14px;
            }
            .food-item-card {
                padding: 15px;
            }
            .food-item-card h3 {
                font-size: 18px;
            }
            .food-item-card .details span,
            .food-item-card .main-materials span {
                font-size: 12px;
                padding: 4px 8px;
            }
            .raw-material-item-card {
                padding: 15px;
            }
            .raw-material-item-card h3 {
                font-size: 16px;
            }
            .raw-material-item-card .details span {
                font-size: 12px;
            }
             .sidebar {
                flex-direction: column; /* Revert to column for very small screens if it gets too cramped */
                align-items: stretch;
            }
            .user-profile {
                flex-direction: column; /* Revert user profile to column */
                align-items: center;
                padding-top: 15px;
                margin-top: 15px;
                border-top: 1px solid #eee;
            }
            .user-profile .user-info {
                text-align: center;
            }
            .user-profile .logout-button {
                margin-right: 0;
            }
        }

        /* New styles for weekly schedule view */
        .weekly-schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .day-card {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            padding: 20px;
        }

        .day-card h4 {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }

        .meal-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .meal-list li {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .meal-list li:last-child {
            border-bottom: none;
        }
        .meal-time-title {
            font-weight: bold;
            color: #333;
            font-size: 15px;
        }
        .meal-info {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .meal-info .food-name {
            font-weight: 500;
            color: #4CAF50;
        }
        .meal-actions {
             display: flex;
             justify-content: flex-end;
             gap: 8px;
        }
        .meal-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">مدیریت رستوران</div>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#" data-section="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> داشبورد</a></li>
                    <li><a href="#" data-section="raw-material-management"><i class="fas fa-boxes"></i> مدیریت مواد اولیه</a></li>
                    <li><a href="#" data-section="add-new-food"><i class="fas fa-plus-circle"></i> تعریف غذای جدید</a></li>

                    <li><a href="#" data-section="food-list"><i class="fas fa-utensils"></i> لیست غذاها</a></li>

                    <li><a href="#" data-section="weekly-schedule"><i class="fas fa-calendar-alt"></i> برنامه هفتگی غذا</a></li>
                </ul>
            </nav>
            <div class="user-profile">
                <div class="avatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <div class="name">سعید عبدالحسینی</div>
                    <div class="role">مدیر سیستم</div>
                </div>
                <button class="logout-button" onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>
        </aside>

        <main class="main-content">
            <section id="dashboard" class="content-section active">
                <div class="header">
                    <h1>داشبورد مدیریت</h1>
                    <button class="add-button" onclick="showSection('add-new-food')"><i class="fas fa-plus"></i> غذاي جدید</button>
                </div>

                <div class="cards-container">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon purple"><i class="fas fa-tags"></i></div>
                            <span class="card-title">دسته بندی ها</span>
                        </div>
                        <div class="card-value" id="dashboard-total-categories">۰</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon blue"><i class="fas fa-box-open"></i></div>
                            <span class="card-title">مواد اولیه</span>
                        </div>
                        <div class="card-value" id="dashboard-total-raw-materials">۰</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon green"><i class="fas fa-utensils"></i></div>
                            <span class="card-title">تعداد غذاها</span>
                        </div>
                        <div class="card-value" id="dashboard-total-foods">۰</div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-main-area">
                        <div class="table-container" style="margin-bottom: 20px;">
                            <h2>لیست غذاها</h2>
                            <table id="dashboardFoodTable">
                                <thead>
                                    <tr>
                                        <th>نام غذا</th>
                                        <th>دسته بندی</th>
                                        <th>تعداد مواد اولیه</th>
                                        <th>سایزها</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>

                        <div class="chart-card">
                            <h3>ساختار چلو کباب کوبیده</h3>
                            <div id="kabobStructureList">
                                </div>
                        </div>
                    </div>

                    <div class="dashboard-charts-area">
                        <div class="chart-card">
                            <h3>مواد اولیه پرمصرف</h3>
                            <div id="topConsumedMaterialsList">
                                </div>
                        </div>

                        <div class="chart-card">
                            <h3>وضعیت موجودی</h3>
                            <div id="stockStatusList">
                                </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="food-list" class="content-section">
                <div class="header">
                    <h1>لیست غذاها</h1>
                    <button class="add-button" onclick="showSection('add-new-food')"><i class="fas fa-plus"></i> غذای جدید</button>
                </div>
                <div class="search-filter-bar">
                    <button class="add-button" onclick="showSection('add-new-food')"><i class="fas fa-plus"></i> افزودن غذای جدید</button>
                    <div class="filter-dropdown">
                        <select id="foodListCategoryFilter">
                            <option value="">همه دسته‌بندی‌ها</option>
                            </select>
                    </div>
                    <div class="search-input">
                        <input type="text" id="foodListSearchInput" placeholder="جستجو در غذاها...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <div class="food-list-cards" id="foodListCardsContainer">
                    </div>
            </section>

            <section id="add-new-food" class="content-section">
                <div class="header">
                    <h1>تعریف غذای جدید</h1>
                    <button class="add-button" onclick="showSection('food-list')"><i class="fas fa-arrow-right"></i> بازگشت به لیست</button>
                </div>
                <div class="form-container">
                    <h2>اطلاعات پایه</h2>
                    <input type="hidden" id="foodIdForEdit">
                    <div class="form-group inline-group">
                        <div>
                            <label for="foodName">نام غذا</label>
                            <input type="text" id="foodName" placeholder="مثال: چلو کباب کوبیده" required>
                        </div>
                        <div>
                            <label for="foodCategory"> دسته بندی(اختیاری)</label>
                            <select id="foodCategory" required>
                                </select>
                        </div>
                    </div>
                    <div class="form-group inline-group">
                        <div>
                            <label for="foodType">نوع غذا</label>
                            <select id="foodType" required>
                                <option value="">نوع غذا را انتخاب کنید...</option>
                                <option value="main">غذای اصلی</option>
                                <option value="appetizer">پیش غذا</option>
                                <option value="dessert">دسر</option>
                            </select>
                        </div>
                         <div>
                            <label for="preparationTime">زمان آماده‌سازی (دقیقه)</label>
                            <input type="number" id="preparationTime" placeholder="مثال: 45" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="foodDescription">توضیحات</label>
                        <textarea id="foodDescription" rows="4" placeholder="توضیحات مختصر درباره غذا..."></textarea>
                    </div>

                    <h2 style="margin-top: 30px; margin-bottom: 20px;">مواد اولیه</h2>
                    <button class="add-material-btn" id="addFoodMaterialBtn"><i class="fas fa-plus"></i> افزودن ماده اولیه</button>
                    <div class="raw-materials-list" id="foodMaterialsList">
                        </div>

                    <div class="form-actions">
                        <button class="save-btn" id="saveFoodBtn"><i class="fas fa-save"></i> ذخیره غذا</button>
                        <button class="cancel-btn" onclick="showSection('food-list')"><i class="fas fa-times-circle"></i> انصراف</button>
                    </div>
                </div>
            </section>


            <section id="raw-material-management" class="content-section">
                <div class="header">
                    <h1>مدیریت مواد اولیه</h1>
                    <button class="add-button" onclick="showAddRawMaterialForm()"><i class="fas fa-plus"></i> افزودن ماده اولیه جدید</button>
                </div>
                <div class="search-filter-bar">
                    <button class="add-button" onclick="showAddRawMaterialForm()"><i class="fas fa-plus"></i> افزودن ماده اولیه جدید</button>
                    <div class="filter-dropdown">
                        <select id="rawMaterialListCategoryFilter">
                            <option value="">فیلتر</option>
                            </select>
                    </div>
                    <div class="search-input">
                        <input type="text" id="rawMaterialListSearchInput" placeholder="جستجو در مواد اولیه...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <div class="raw-material-list-cards" id="rawMaterialListCardsContainer">
                    </div>

                <div class="dashboard-charts-area" style="margin-top: 30px;">
                    <div class="chart-card">
                        <h3>مواد اولیه پرمصرف</h3>
                        <div id="rawMaterialTopConsumedList">
                            </div>
                    </div>

                    <div class="chart-card">
                        <h3>وضعیت موجودی</h3>
                        <div id="rawMaterialStockStatusListSection">
                            </div>
                    </div>
                </div>
            </section>

            <section id="add-new-raw-material" class="content-section">
                <div class="header">
                    <h1>افزودن ماده اولیه جدید</h1>
                    <button class="add-button" onclick="showSection('raw-material-management')"><i class="fas fa-arrow-right"></i> بازگشت</button>
                </div>
                <div class="form-container">
                    <input type="hidden" id="rawMaterialIdForEdit">
                    <div class="form-group">
                        <label for="rawMaterialName">نام ماده اولیه</label>
                        <input type="text" id="rawMaterialName" placeholder="مثال: زعفران" required>
                    </div>
                    <div class="form-group inline-group">
                        <div>
                            <label for="rawMaterialCategory">دسته بندی</label>
                            <select id="rawMaterialCategory" required>
                                </select>
                        </div>
                        <div>
                            <label for="rawMaterialUnit">واحد اندازه‌گیری</label>
                            <select id="rawMaterialUnit" required>
                                <option value="gram">گرم</option>
                                <option value="kg">کیلوگرم</option>
                                <option value="milliliter">میلی لیتر</option>
                                <option value="liter">لیتر</option>
                                <option value="piece">عدد</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="rawMaterialPrice">قیمت واحد (ریال)</label>
                        <input type="text" id="rawMaterialPrice" class="formatted-price" value="0" pattern="[0-9,]*" inputmode="numeric" required>
                        <span class="price-display">معادل: <span id="tomanPriceDisplay">۰</span> تومان</span>
                    </div>
                    <div class="form-group">
                        <label for="codinglbl">کدینگ</label>
                        <input type="text" id="codinglbl" value="" placeholder="مثال: RM001">
                    </div>
                    <div class="form-group">
                        <label for="rawMaterialDescription">توضیحات</label>
                        <textarea id="rawMaterialDescription" rows="4" placeholder="توضیحات اضافی درباره این ماده اولیه..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button class="save-btn" id="saveRawMaterialBtn"><i class="fas fa-save"></i> ذخیره ماده اولیه</button>
                        <button class="cancel-btn" onclick="showSection('raw-material-management')"><i class="fas fa-times-circle"></i> انصراف</button>
                    </div>
                </div>
            </section>


            <section id="weekly-schedule" class="content-section">
                <div class="header">
                    <h1>برنامه هفتگی غذا</h1>
                    <button class="add-button" onclick="showAddWeeklyScheduleForm()"><i class="fas fa-plus"></i> افزودن برنامه</button>
                </div>

                <div class="search-filter-bar">
                    <button class="add-button" onclick="showAddWeeklyScheduleForm()"><i class="fas fa-plus"></i> افزودن برنامه</button>

                    <div style="display: flex; align-items: center; gap: 10px; margin: 0 auto;">

                    </div>


                </div>

                <div class="weekly-schedule-grid" id="weeklyScheduleGrid">
                    </div>
            </section>


  <section id="add-weekly-schedule" class="content-section">
    <div class="header">
        <h1>افزودن / ویرایش برنامه هفتگی</h1>
        <button class="add-button" onclick="showSection('weekly-schedule')"><i class="fas fa-arrow-right"></i> بازگشت به برنامه</button>
    </div>
    <div class="form-container">
        <div id="form-error-message" style="color: red; margin-bottom: 20px; text-align: center; font-weight: bold;"></div>

        <input type="hidden" id="weeklyScheduleIdForEdit">

        <div class="form-group">
            <label for="scheduleFood">غذا</label>
            <select id="scheduleFood" required>
                <option value="">یک غذا انتخاب کنید...</option>
                </select>
        </div>

        <div class="form-group inline-group">
            <div>
                <label for="scheduleDate">تاریخ</label>
                <input type="text" id="scheduleDate" data-jdp placeholder="تاریخ را از تقویم انتخاب کنید" required>
            </div>
            <div>
                <label for="scheduleMealTime">وعده غذایی</label>
                <select id="scheduleMealTime" required>
                    <option value="">وعده را انتخاب کنید...</option>
                    <option value="breakfast">صبحانه</option>
                    <option value="lunch">ناهار</option>
                    <option value="dinner">شام</option>
                    <option value="snack">میان وعده</option>
                </select>
            </div>
        </div>

        <div class="form-group inline-group">
            <div>
                <label for="scheduleCapacity1">ظرفیت حضرتی</label>
                <input type="number" id="scheduleCapacity1" value="0" min="0" placeholder="مثال: 100">
            </div>
            <div>
                <label for="scheduleCapacity2">ظرفیت فروشی</label>
                <input type="number" id="scheduleCapacity2" value="0" min="0" placeholder="مثال: 50">
            </div>
            <div>
                <label for="cookingAmount">مقدار طبخ (کل)</label>
                <input type="number" id="cookingAmount" value="0" min="0" placeholder="مثال: 150">
            </div>
        </div>

        <div class="form-actions">
            <button class="save-btn" id="saveWeeklyScheduleBtn"><i class="fas fa-save"></i> ذخیره برنامه</button>
            <button class="cancel-btn" onclick="showSection('weekly-schedule')"><i class="fas fa-times-circle"></i> انصراف</button>
        </div>
    </div>
</section>

        </main>
    </div>

    <script>


        const BASE_API_URL = 'https://panelresturant.ir/api/';
        const LOGIN_PAGE_URL = '/api/loginToAddFood';


        let editingFoodId = null;
        let editingRawMaterialId = null;
        let editingWeeklyScheduleId = null;



        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP Error! Status: ${response.status}, Details: ${errorText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching data from ${url}:`, error);
                alert(`Error loading data from server: ${error.message}`);
                return null;
            }
        }

        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) {
                return meta.getAttribute('content');
            }
            console.error('CSRF meta tag not found. This page must be rendered by Django.');
            return null;
        }

        async function postData(url, data) {
            const csrftoken = getCsrfToken();
            if (!csrftoken) {
                alert('Error: CSRF token not found. Cannot send data. Please refresh the page.');
                return null;
            }
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.text();
                    let errorMessage = errorData;
                    try {
                        const jsonError = JSON.parse(errorData);
                        errorMessage = JSON.stringify(jsonError, null, 2);
                        console.error('Server error details:', jsonError);
                    } catch (e) {
                        console.error('Server returned non-JSON error:', errorData);
                    }
                    alert(`خطا در ارسال اطلاعات به سرور!\n\nStatus: ${response.status}\n\nDetails: ${errorMessage}`);
                    throw new Error(`HTTP Error! Status: ${response.status}, Details: ${errorData}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error sending data to ${url}:`, error);
                return null;
            }
        }

        async function putData(url, data) {
            const csrftoken = getCsrfToken();
            if (!csrftoken) {
                alert('Error: CSRF token not found. Cannot update data. Please refresh the page.');
                return null;
            }
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.text();
                    let errorMessage = errorData;
                    try {
                        const jsonError = JSON.parse(errorData);
                        errorMessage = JSON.stringify(jsonError, null, 2);
                        console.error('Server error details:', jsonError);
                    } catch (e) {
                        console.error('Server returned non-JSON error:', errorData);
                    }
                    alert(`خطا در به‌روزرسانی اطلاعات!\n\nStatus: ${response.status}\n\nDetails: ${errorMessage}`);
                    throw new Error(`HTTP Error! Status: ${response.status}, Details: ${errorData}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error updating data to ${url}:`, error);
                return null;
            }
        }

        async function deleteData(url) {
            const csrftoken = getCsrfToken();
             if (!csrftoken) {
                alert('Error: CSRF token not found. Cannot delete data. Please refresh the page.');
                return false;
            }
            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    }
                });
                if (!response.ok && response.status !== 204) { // 204 No Content is a success status for DELETE
                    const errorText = await response.text();
                    alert(`خطا در حذف اطلاعات: ${errorText}`);
                    throw new Error(`HTTP Error! Status: ${response.status}, Details: ${errorText}`);
                }
                return true;
            } catch (error) {
                console.error(`Error deleting data from ${url}:`, error);
                return false;
            }
        }


        // --- Logout Function ---
        function logout() {
            if (confirm("آیا مطمئن هستید که می‌خواهید از سیستم خارج شوید؟")) {
                document.cookie = "is_logged_in=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                window.location.href = '/';
            }
        }


        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const contentSections = document.querySelectorAll('.content-section');

        function showSection(sectionId) {
            sidebarLinks.forEach(link => link.classList.remove('active'));
            contentSections.forEach(section => section.classList.remove('active'));

            const targetLink = document.querySelector(`.sidebar-menu a[data-section="${sectionId}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
            document.getElementById(sectionId).classList.add('active');


            editingFoodId = null;
            editingRawMaterialId = null;
            editingWeeklyScheduleId = null;

            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'food-list') {
                loadFoodListData();
            } else if (sectionId === 'raw-material-management') {
                loadRawMaterialListData();
                loadDashboardCharts();
            } else if (sectionId === 'add-new-food') {
                document.getElementById('saveFoodBtn').textContent = 'ذخیره غذا';
                document.getElementById('foodIdForEdit').value = '';
                clearFoodForm();
                populateFoodFormDropdowns();
            } else if (sectionId === 'add-new-raw-material') {
                document.getElementById('saveRawMaterialBtn').textContent = 'ذخیره ماده اولیه';
                document.getElementById('rawMaterialIdForEdit').value = '';
                clearRawMaterialForm();
                populateRawMaterialFormDropdowns();
            } else if (sectionId === 'weekly-schedule') {
                window.loadWeeklyScheduleData();
            } else if (sectionId === 'add-weekly-schedule') {
                document.getElementById('saveWeeklyScheduleBtn').textContent = 'ذخیره برنامه';
                document.getElementById('weeklyScheduleIdForEdit').value = '';
                clearWeeklyScheduleForm();
                window.populateScheduleFoodDropdown();
            }
        }

        window.showAddRawMaterialForm = function() {
            showSection('add-new-raw-material');
        }
        window.showAddWeeklyScheduleForm = function() {
            showSection('add-weekly-schedule');
        }

        function clearFoodForm() {
            document.getElementById('foodName').value = '';
            document.getElementById('foodCategory').value = '';
            document.getElementById('foodType').value = '';
            document.getElementById('preparationTime').value = '';
            document.getElementById('foodDescription').value = '';
            document.getElementById('foodMaterialsList').innerHTML = '';
        }

        function clearRawMaterialForm() {
            document.getElementById('rawMaterialName').value = '';
            document.getElementById('rawMaterialCategory').value = '';
            document.getElementById('rawMaterialUnit').value = 'gram';
            document.getElementById('rawMaterialPrice').value = '0';
            document.getElementById('tomanPriceDisplay').textContent = '۰';
            document.getElementById('codinglbl').value = '';
            document.getElementById('rawMaterialDescription').value = '';
        }

        function clearWeeklyScheduleForm() {
            document.getElementById('scheduleFood').value = '';
            document.getElementById('scheduleDate').value = '';
            document.getElementById('scheduleMealTime').value = '';
            document.getElementById('scheduleCapacity1').value = '0';
            document.getElementById('scheduleCapacity2').value = '0';
            document.getElementById('cookingAmount').value = '0';
        }

        // --- Price formatting helper functions ---
        function formatRial(number) {
            if (number === 0 || isNaN(number)) return '۰';
            return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function getNumericValue(formattedString) {
            if (!formattedString) return 0;
            return parseInt(formattedString.replace(/,/g, '')) || 0;
        }

        function updateTomanDisplay() {
            const rawMaterialPriceInput = document.getElementById('rawMaterialPrice');
            const tomanPriceDisplay = document.getElementById('tomanPriceDisplay');
            const rawValue = getNumericValue(rawMaterialPriceInput.value);
            const tomanValue = Math.floor(rawValue / 10);
            tomanPriceDisplay.textContent = formatRial(tomanValue);
        }
        // --- End of Price formatting helper functions ---


        async function loadDashboardData() {
            const data = await fetchData(`${BASE_API_URL}dashboard-stats/`);
            if (!data) return;

            document.getElementById('dashboard-total-categories').textContent = data.total_categories;
            document.getElementById('dashboard-total-raw-materials').textContent = data.total_raw_materials;
            document.getElementById('dashboard-total-foods').textContent = data.total_foods;

            const foods = await fetchData(`${BASE_API_URL}foods/`);
            if (foods) {
                renderDashboardFoodTable(foods);
            }

            const kabobStructureList = document.getElementById('kabobStructureList');
            kabobStructureList.innerHTML = '';
            if (data.example_food_structure && data.example_food_structure.length > 0) {
                data.example_food_structure.forEach(item => {
                    const div = document.createElement('div');
                    div.classList.add('material-item');
                    div.innerHTML = `<div class="quantity">${item.quantity}</div><div class="description">${item.description}</div>`;
                    kabobStructureList.appendChild(div);
                });
            } else {
                 kabobStructureList.innerHTML = '<p>ساختار غذایی برای "چلو کباب کوبیده" یافت نشد.</p>';
            }

            const topConsumedMaterialsList = document.getElementById('topConsumedMaterialsList');
            topConsumedMaterialsList.innerHTML = '';
            if (data.top_consumed_materials && data.top_consumed_materials.length > 0) {
                const colors = ['#c8e6c9', '#ffccbc', '#fff9c4'];
                data.top_consumed_materials.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.classList.add('material-item');
                    div.innerHTML = `
                        <div class="color-box" style="background-color: ${colors[index % colors.length]};"></div>
                        <div class="quantity">${item.total_needed} ${item.raw_material__unit_of_measurement}</div>
                        <div class="description">${item.raw_material__name} <small> (مقدار کل لازم)</small></div>
                    `;
                    topConsumedMaterialsList.appendChild(div);
                });
            } else {
                topConsumedMaterialsList.innerHTML = '<p>اطلاعاتی یافت نشد.</p>';
            }

            const stockStatusList = document.getElementById('stockStatusList');
            stockStatusList.innerHTML = '';
            if (data.stock_status && data.stock_status.length > 0) {
                data.stock_status.forEach(item => {
                    const div = document.createElement('div');
                    let progressColorClass = 'green';
                    if (item.percentage < 30) {
                        progressColorClass = 'red';
                    } else if (item.percentage < 70) {
                        progressColorClass = 'orange';
                    }
                    div.innerHTML = `
                        <div class="progress-text">
                            <span>${item.name}</span>
                            <span>${item.percentage}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressColorClass}" style="width: ${item.percentage}%;"></div>
                        </div>
                    `;
                    stockStatusList.appendChild(div);
                });
            } else {
                stockStatusList.innerHTML = '<p>اطلاعاتی یافت نشد.</p>';
            }
        }

        function renderDashboardFoodTable(foods) {
            const tbody = document.querySelector('#dashboardFoodTable tbody');
            tbody.innerHTML = '';

            if (foods && foods.length > 0) {
                foods.slice(0, 5).forEach(food => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${food.name}</td>
                        <td><span class="tag ${getCategoryTagClass(food.category_name)}">${food.category_name || 'نامشخص'}</span></td>
                        <td>${food.raw_materials_count}</td>
                        <td>${food.available_sizes ? food.available_sizes.map(s => `<span class="food-sizes">${s.name}</span>`).join(' ') : ''}</td>
                        <td class="table-actions">
                            <button class="edit-btn" onclick="editFood(${food.id})"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" onclick="deleteFood(${food.id}, '${food.name}')"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                });
            } else {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center;">هیچ غذایی یافت نشد.</td>';
            }
        }



        async function loadFoodListData(categoryId = '', searchQuery = '') {
            let url = `${BASE_API_URL}foods/`;
            const params = new URLSearchParams();
            if (categoryId) params.append('category_id', categoryId);
            if (searchQuery) params.append('search', searchQuery);
            if (params.toString()) url += `?${params.toString()}`;

            const foods = await fetchData(url);
            if (!foods) return;

            const foodListCardsContainer = document.getElementById('foodListCardsContainer');
            foodListCardsContainer.innerHTML = '';

            if (foods.length > 0) {
                foods.forEach(food => {
                    const rawMaterialsHtml = food.food_raw_materials && food.food_raw_materials.length > 0
                        ? food.food_raw_materials.map(material => {
                            return `<span>${material.raw_material_name} (${material.quantity_needed} ${material.unit_of_measurement})</span>`;
                          }).join('')
                        : '<span>ماده اولیه‌ای تعریف نشده است.</span>';

                    const card = document.createElement('div');
                    card.classList.add('food-item-card');
                    card.innerHTML = `
                        <h3>${food.name}</h3>
                        <div class="details">
                            <span class="tag ${getCategoryTagClass(food.category_name)}">${food.category_name || 'نامشخص'}</span>
                            <span><i class="fas fa-utensils"></i> نوع غذا: ${getFoodTypeDisplay(food.food_type)}</span>
                            ${food.preparation_time_minutes ? `<span><i class="fas fa-clock"></i> زمان آماده‌سازی: ${food.preparation_time_minutes} دقیقه</span>` : ''}
                        </div>
                        <div class="main-materials">
                            <h4>مواد اولیه:</h4>
                            ${rawMaterialsHtml}
                        </div>
                        <div class="card-actions">
                            <button class="edit-btn" onclick="editFood(${food.id})"><i class="fas fa-edit"></i> ویرایش</button>
                            <button class="delete-btn" onclick="deleteFood(${food.id}, '${food.name}')"><i class="fas fa-trash-alt"></i> حذف</button>
                        </div>
                    `;
                    foodListCardsContainer.appendChild(card);
                });
            } else {
                foodListCardsContainer.innerHTML = '<p style="text-align: center;">هیچ غذایی با این مشخصات یافت نشد.</p>';
            }
        }

        window.editFood = async function(foodId) {
            showSection('add-new-food'); // Navigate to the add new food form
            editingFoodId = foodId; // Set the global editing ID
            document.getElementById('saveFoodBtn').textContent = 'به‌روزرسانی غذا'; // Change button text

            const food = await fetchData(`${BASE_API_URL}foods/${foodId}/`);
            if (!food) return;

            document.getElementById('foodIdForEdit').value = food.id;
            document.getElementById('foodName').value = food.name;
            document.getElementById('foodCategory').value = food.category;
            document.getElementById('foodType').value = food.food_type; // New
            document.getElementById('preparationTime').value = food.preparation_time_minutes || '';
            document.getElementById('foodDescription').value = food.description || '';

            // Populate raw materials
            const foodMaterialsList = document.getElementById('foodMaterialsList');
            foodMaterialsList.innerHTML = ''; // Clear existing materials
            if (food.food_raw_materials && food.food_raw_materials.length > 0) {
                food.food_raw_materials.forEach(material => {
                    addFoodMaterialRow(material.raw_material, material.quantity_needed, material.notes, material.id);
                });
            }
        }

        window.deleteFood = async function(foodId, foodName) {
            if (confirm(`آیا مطمئن هستید که می‌خواهید غذای "${foodName}" را حذف کنید؟ این عمل غیرقابل بازگشت است.`)) {
                const success = await deleteData(`${BASE_API_URL}foods/${foodId}/`);
                if (success) {
                    alert(`غذای "${foodName}" با موفقیت حذف شد.`);
                    loadFoodListData();
                    loadDashboardData();
                }
            }
        }


        async function loadRawMaterialListData(categoryId = '', searchQuery = '') {
            let url = `${BASE_API_URL}raw-materials/`;
            const params = new URLSearchParams();
            if (categoryId) params.append('category_id', categoryId);
            if (searchQuery) params.append('search', searchQuery);
            if (params.toString()) url += `?${params.toString()}`;

            const rawMaterials = await fetchData(url);
            if (!rawMaterials) return;

            const rawMaterialListCardsContainer = document.getElementById('rawMaterialListCardsContainer');
            rawMaterialListCardsContainer.innerHTML = '';

            if (rawMaterials.length > 0) {
                rawMaterials.forEach(material => {
                    const card = document.createElement('div');
                    card.classList.add('raw-material-item-card');
                    card.innerHTML = `
                        <div class="info">
                            <h3>${material.name}</h3>
                            <div class="details">
                                <span class="tag ${getCategoryTagClass(material.category_name)}">${material.category_name || 'بدون دسته'}</span>
                                <span>واحد: <strong>${material.unit_of_measurement}</strong></span>
                                <span>قیمت واحد: <strong>${formatRial(material.unit_price)}</strong></span>
                                ${material.coding ? `<span>کدینگ: <strong>${material.coding}</strong></span>` : ''}

                            </div>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" onclick="editRawMaterial(${material.id})"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" onclick="deleteRawMaterial(${material.id}, '${material.name}')"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    rawMaterialListCardsContainer.appendChild(card);
                });
            } else {
                rawMaterialListCardsContainer.innerHTML = '<p style="text-align: center;">ماده اولیه‌ای یافت نشد.</p>';
            }
        }

        window.editRawMaterial = async function(rawMaterialId) {
            showSection('add-new-raw-material');
            editingRawMaterialId = rawMaterialId;
            document.getElementById('saveRawMaterialBtn').textContent = 'به‌روزرسانی ماده اولیه';

            const rawMaterial = await fetchData(`${BASE_API_URL}raw-materials/${rawMaterialId}/`);
            if (!rawMaterial) return;

            document.getElementById('rawMaterialIdForEdit').value = rawMaterial.id;
            document.getElementById('rawMaterialName').value = rawMaterial.name;
            document.getElementById('rawMaterialCategory').value = rawMaterial.category;
            document.getElementById('rawMaterialUnit').value = rawMaterial.unit_of_measurement;
            document.getElementById('rawMaterialPrice').value = formatRial(rawMaterial.unit_price);
            updateTomanDisplay();
            document.getElementById('codinglbl').value = rawMaterial.coding || '';
            document.getElementById('rawMaterialDescription').value = rawMaterial.description || '';
        }

        window.deleteRawMaterial = async function(rawMaterialId, rawMaterialName) {
            if (confirm(`آیا مطمئن هستید که می‌خواهید ماده اولیه "${rawMaterialName}" را حذف کنید؟ این عمل غیرقابل بازگشت است.`)) {
                const success = await deleteData(`${BASE_API_URL}raw-materials/${rawMaterialId}/`);
                if (success) {
                    alert(`ماده اولیه "${rawMaterialName}" با موفقیت حذف شد.`);
                    loadRawMaterialListData();
                    loadDashboardData();
                }
            }
        }


        async function loadDashboardCharts() {
            const data = await fetchData(`${BASE_API_URL}dashboard-stats/`);
            if (!data) return;

            const rawMaterialTopConsumedList = document.getElementById('rawMaterialTopConsumedList');
            rawMaterialTopConsumedList.innerHTML = '';
            if (data.top_consumed_materials && data.top_consumed_materials.length > 0) {
                 data.top_consumed_materials.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.classList.add('material-item');
                    const colors = ['#c8e6c9', '#ffccbc', '#fff9c4'];
                    div.innerHTML = `
                        <div class="color-box" style="background-color: ${colors[index % colors.length]};"></div>
                        <div class="quantity">${item.total_needed} ${item.raw_material__unit_of_measurement}</div>
                        <div class="description">${item.raw_material__name} <small> (مقدار کل لازم)</small></div>
                    `;
                    rawMaterialTopConsumedList.appendChild(div);
                });
            } else {
                rawMaterialTopConsumedList.innerHTML = '<p>اطلاعاتی یافت نشد.</p>';
            }

            const rawMaterialStockStatusList = document.getElementById('rawMaterialStockStatusListSection');
            rawMaterialStockStatusList.innerHTML = '';
            if (data.stock_status && data.stock_status.length > 0) {
                data.stock_status.forEach(item => {
                    const div = document.createElement('div');
                    let progressColorClass = 'green';
                    if (item.percentage < 30) progressColorClass = 'red';
                    else if (item.percentage < 70) progressColorClass = 'orange';

                    div.innerHTML = `
                        <div class="progress-text">
                            <span>${item.name}</span>
                            <span>${item.percentage}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressColorClass}" style="width: ${item.percentage}%;"></div>
                        </div>
                    `;
                    rawMaterialStockStatusList.appendChild(div);
                });
            } else {
                rawMaterialStockStatusList.innerHTML = '<p>اطلاعاتی یافت نشد.</p>';
            }
        }


        async function populateCategories(selectElementId, defaultOptionText = 'Select') {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;

            const categories = await fetchData(`${BASE_API_URL}categories/`);
            if (!categories) return;

            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                selectElement.appendChild(option);
            });
        }

        async function populateFoodFormDropdowns() {
            await populateCategories('foodCategory', 'یک دسته بندی انتخاب کنید');
            await populateRawMaterialsForFoodForm();
        }

        async function populateRawMaterialFormDropdowns() {
            await populateCategories('rawMaterialCategory', 'یک دسته بندی انتخاب کنید');
        }

        async function populateRawMaterialsForFoodForm() {
            const rawMaterials = await fetchData(`${BASE_API_URL}raw-materials/`);
            if (!rawMaterials) return;
            window.allRawMaterials = rawMaterials;
        }

        window.populateScheduleFoodDropdown = async function() {
            const selectElement = document.getElementById('scheduleFood');
            if (!selectElement) return;

            const foods = await fetchData(`${BASE_API_URL}foods/`);
            if (!foods) return;

            selectElement.innerHTML = `<option value="">یک غذا انتخاب کنید...</option>`;
            foods.forEach(food => {
                const option = document.createElement('option');
                option.value = food.id;
                option.textContent = food.name;
                selectElement.appendChild(option);
            });
        }



        document.addEventListener('DOMContentLoaded', () => {
            showSection('dashboard');

            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.currentTarget.dataset.section;
                    showSection(sectionId);
                });
            });


            const foodListCategoryFilter = document.getElementById('foodListCategoryFilter');
            const foodListSearchInput = document.getElementById('foodListSearchInput');

            if (foodListCategoryFilter) {
                populateCategories('foodListCategoryFilter', 'همه دسته‌بندی‌ها');
                foodListCategoryFilter.addEventListener('change', () => {
                    loadFoodListData(foodListCategoryFilter.value, foodListSearchInput.value);
                });
            }
            if (foodListSearchInput) {
                foodListSearchInput.addEventListener('input', () => {
                    loadFoodListData(foodListCategoryFilter.value, foodListSearchInput.value);
                });
            }



            const rawMaterialListCategoryFilter = document.getElementById('rawMaterialListCategoryFilter');
            const rawMaterialListSearchInput = document.getElementById('rawMaterialListSearchInput');

            if (rawMaterialListCategoryFilter) {
                populateCategories('rawMaterialListCategoryFilter', 'همه دسته‌بندی‌ها');
                rawMaterialListCategoryFilter.addEventListener('change', () => {
                    loadRawMaterialListData(rawMaterialListCategoryFilter.value, rawMaterialListSearchInput.value);
                });
            }
            if (rawMaterialListSearchInput) {
                rawMaterialListSearchInput.addEventListener('input', () => {
                    loadRawMaterialListData(rawMaterialListCategoryFilter.value, rawMaterialListSearchInput.value);
                });
            }

            const rawMaterialPriceInput = document.getElementById('rawMaterialPrice');
            if (rawMaterialPriceInput) {
                rawMaterialPriceInput.addEventListener('input', function(e) {
                    const value = this.value.replace(/[^0-9]/g, '');
                    this.value = formatRial(getNumericValue(value));
                    updateTomanDisplay();
                });
                 rawMaterialPriceInput.addEventListener('blur', function() {
                    this.value = formatRial(getNumericValue(this.value));
                    updateTomanDisplay();
                });
            }


            const addFoodMaterialBtn = document.getElementById('addFoodMaterialBtn');
            const foodMaterialsList = document.getElementById('foodMaterialsList');
            const saveFoodBtn = document.getElementById('saveFoodBtn');

            function addFoodMaterialRow(rawMaterialId = '', quantity = '', notes = '', foodRawMaterialId = null) {
                if (!window.allRawMaterials || window.allRawMaterials.length === 0) {
                    alert('لطفاً ابتدا چند ماده اولیه تعریف کنید.');
                    return;
                }
                const newMaterialRow = document.createElement('div');
                newMaterialRow.classList.add('material-row');
                newMaterialRow.setAttribute('data-food-raw-material-id', foodRawMaterialId || '');
                newMaterialRow.innerHTML = `
                    <div>
                        <label>نام ماده اولیه</label>
                        <select class="raw-material-select" required>
                            <option value="">انتخاب کنید...</option>
                        </select>
                    </div>
                    <div>
                        <label>مقدار</label>
                        <input type="number" step="0.01" min="0" value="${quantity}" required>
                    </div>
                    <div>
                        <label>واحد</label>
                        <input type="text" class="raw-material-unit-display" disabled placeholder="واحد" />
                    </div>
                    <div>
                        <label>توضیحات</label>
                        <input type="text" value="${notes}" placeholder="اختیاری...">
                    </div>
                    <div class="actions">
                        <button type="button" class="delete-material-btn"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `;
                foodMaterialsList.appendChild(newMaterialRow);

                const select = newMaterialRow.querySelector('.raw-material-select');
                const unitDisplay = newMaterialRow.querySelector('.raw-material-unit-display');

                window.allRawMaterials.forEach(rm => {
                    const option = document.createElement('option');
                    option.value = rm.id;
                    option.textContent = rm.name;
                    select.appendChild(option);
                });

                if (rawMaterialId) {
                    select.value = rawMaterialId;
                    const selectedRawMaterial = window.allRawMaterials.find(rm => rm.id == rawMaterialId);
                    unitDisplay.value = selectedRawMaterial ? selectedRawMaterial.unit_of_measurement : '';
                }

                select.addEventListener('change', (e) => {
                    const selectedRawMaterialId = e.target.value;
                    const selectedRawMaterial = window.allRawMaterials.find(rm => rm.id == selectedRawMaterialId);
                    unitDisplay.value = selectedRawMaterial ? selectedRawMaterial.unit_of_measurement : '';
                });

                newMaterialRow.querySelector('.delete-material-btn').addEventListener('click', async (e) => {
                    const rowToRemove = e.currentTarget.closest('.material-row');
                    const foodRawMaterialIdToDelete = rowToRemove.getAttribute('data-food-raw-material-id');

                    if (foodRawMaterialIdToDelete && editingFoodId) {
                        if (confirm('آیا مطمئن هستید که می‌خواهید این ماده اولیه را از غذا حذف کنید؟')) {
                            const success = await deleteData(`${BASE_API_URL}food-raw-materials/${foodRawMaterialIdToDelete}/`);
                            if (success) {
                                alert('ماده اولیه غذا با موفقیت حذف شد.');
                                rowToRemove.remove();
                            }
                        }
                    } else {
                        rowToRemove.remove();
                    }
                });
            }

            if (addFoodMaterialBtn && foodMaterialsList) {
                addFoodMaterialBtn.addEventListener('click', () => addFoodMaterialRow());
            }


            if (saveFoodBtn) {
                saveFoodBtn.addEventListener('click', async () => {
                    const foodName = document.getElementById('foodName').value;
                    const foodCategory = document.getElementById('foodCategory').value;
                    const foodType = document.getElementById('foodType').value;
                    const foodDescription = document.getElementById('foodDescription').value;
                    const preparationTime = document.getElementById('preparationTime').value;

                    const foodRawMaterials = [];
                    document.querySelectorAll('#foodMaterialsList .material-row').forEach(row => {
                        const rawMaterialId = row.querySelector('.raw-material-select').value;
                        const quantityNeeded = parseFloat(row.querySelector('input[type="number"]').value);
                        const notes = row.querySelector('input[type="text"]').value;
                        const foodRawMaterialId = row.getAttribute('data-food-raw-material-id');

                        if (rawMaterialId && quantityNeeded > 0) {
                            const materialData = {
                                raw_material: parseInt(rawMaterialId),
                                quantity_needed: quantityNeeded,
                                notes: notes
                            };
                            if (foodRawMaterialId) {
                                materialData.id = parseInt(foodRawMaterialId);
                            }
                            foodRawMaterials.push(materialData);
                        }
                    });

                    if (!foodName || !foodCategory || !foodType) {
                        alert('لطفاً تمام فیلدهای الزامی (نام، دسته‌بندی و نوع غذا) را پر کنید.');
                        return;
                    }

                    const foodData = {
                        name: foodName,
                        category: parseInt(foodCategory),
                        food_type: foodType,
                        description: foodDescription,
                        preparation_time_minutes: preparationTime ? parseInt(preparationTime) : null,
                        food_raw_materials: foodRawMaterials
                    };

                    let result = null;
                    if (editingFoodId) {
                        result = await putData(`${BASE_API_URL}foods/${editingFoodId}/`, foodData);
                        if (result) {
                            alert('غذا با موفقیت به‌روزرسانی شد!');
                        }
                    } else {
                        result = await postData(`${BASE_API_URL}foods/`, foodData);
                        if (result) {
                            alert('غذای جدید با موفقیت ذخیره شد!');
                        }
                    }

                    if (result) {
                        clearFoodForm();
                        showSection('food-list');
                    }
                });
            }


            const saveRawMaterialBtn = document.getElementById('saveRawMaterialBtn');
            if (saveRawMaterialBtn) {
                saveRawMaterialBtn.addEventListener('click', async () => {
                    const rawMaterialName = document.getElementById('rawMaterialName').value;
                    const rawMaterialCategory = document.getElementById('rawMaterialCategory').value;
                    const rawMaterialUnit = document.getElementById('rawMaterialUnit').value;
                    const rawMaterialPrice = getNumericValue(document.getElementById('rawMaterialPrice').value);
                    const coding = document.getElementById('codinglbl').value;
                    const rawMaterialDescription = document.getElementById('rawMaterialDescription').value;

                    if (!rawMaterialName || !rawMaterialCategory || !rawMaterialUnit || isNaN(rawMaterialPrice)) {
                        alert('لطفاً تمام فیلدهای الزامی را پر کنید.');
                        return;
                    }

                    const rawMaterialData = {
                        name: rawMaterialName,
                        category: parseInt(rawMaterialCategory),
                        unit_of_measurement: rawMaterialUnit,
                        unit_price: rawMaterialPrice,
                        description: rawMaterialDescription,
                        coding: coding
                    };

                    let result = null;
                    if (editingRawMaterialId) {
                        result = await putData(`${BASE_API_URL}raw-materials/${editingRawMaterialId}/`, rawMaterialData);
                        if (result) {
                            alert('ماده اولیه با موفقیت به‌روزرسانی شد!');
                        }
                    } else {
                        result = await postData(`${BASE_API_URL}raw-materials/`, rawMaterialData);
                        if (result) {
                            alert('ماده اولیه جدید با موفقیت ذخیره شد!');
                        }
                    }

                    if (result) {
                        clearRawMaterialForm();
                        showSection('raw-material-management');
                    }
                });
            }

            // ===========================================
            // --- Weekly Schedule Logic ---
            // ===========================================

            const mealTimeMap = {
                'breakfast': 'صبحانه',
                'lunch': 'ناهار',
                'dinner': 'شام',
                'snack': 'میان وعده'
            };

            const dayOfWeekMap = [
                'شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه'
            ];

            function getStartOfWeek(date) {
                const day = moment(date).day();
                const diff = (day >= 6) ? day - 6 : day + 1;
                return moment(date).add(-diff, 'days').startOf('day');
            }

            window.loadWeeklyScheduleData = async function(date = moment()) {
                const startOfWeek = getStartOfWeek(date);
                const endOfWeek = moment(startOfWeek).add(6, 'days');

                const url = `${BASE_API_URL}weekly-schedule/?start_date=${startOfWeek.format('YYYY-MM-DD')}&end_date=${endOfWeek.format('YYYY-MM-DD')}`;

                const schedules = await fetchData(url);
                if (!schedules) return;

                const groupedByDate = {};
                for (let i = 0; i < 7; i++) {
                    const currentDay = moment(startOfWeek).add(i, 'days');
                    const dateKey = currentDay.format('jYYYY/jMM/jDD');
                    const dayName = dayOfWeekMap[i];
                    groupedByDate[dateKey] = {
                        dayName: dayName,
                        date: currentDay.format('YYYY-MM-DD'),
                        meals: []
                    };
                }

                schedules.forEach(schedule => {
                    const dateKey = moment(schedule.schedule_date).format('jYYYY/jMM/jDD');
                    if (groupedByDate[dateKey]) {
                        groupedByDate[dateKey].meals.push(schedule);
                    }
                });

                renderWeeklyScheduleGrid(groupedByDate);
            }

            function renderWeeklyScheduleGrid(groupedData) {
                const gridContainer = document.getElementById('weeklyScheduleGrid');
                gridContainer.innerHTML = '';

                Object.keys(groupedData).forEach(dateKey => {
                    const dayData = groupedData[dateKey];
                    const dayCard = document.createElement('div');
                    dayCard.classList.add('day-card');

                    let mealsHtml = '';
                    if (dayData.meals.length > 0) {
                        mealsHtml = dayData.meals.map(meal => `
                            <li>
                                <div class="meal-time-title">${mealTimeMap[meal.meal_time]}</div>
                                <div class="meal-info">
                                    <span class="food-name">${meal.food_name}</span>
                                    <span>(حضرتی: ${meal.capacity_nazry || '۰'}, فروشی: ${meal.capacity_foroshi || '۰'})</span>
                                </div>
                                <div class="meal-actions">
                                    <button onclick="editWeeklySchedule(${meal.id})"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteWeeklySchedule(${meal.id}, '${meal.food_name}')"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </li>
                        `).join('');
                    } else {
                        mealsHtml = '<li><small>برنامه‌ای برای این روز ثبت نشده است.</small></li>';
                    }

                    dayCard.innerHTML = `
                        <h4>${dayData.dayName} <br> <small>${dateKey}</small></h4>
                        <ul class="meal-list">
                            ${mealsHtml}
                        </ul>
                    `;
                    gridContainer.appendChild(dayCard);
                });
            }

            window.editWeeklySchedule = async function(scheduleId) {
                showSection('add-weekly-schedule');
                editingWeeklyScheduleId = scheduleId;
                document.getElementById('saveWeeklyScheduleBtn').textContent = 'به‌روزرسانی برنامه';

                const schedule = await fetchData(`${BASE_API_URL}weekly-schedule/${scheduleId}/`);
                if (!schedule) return;

                document.getElementById('weeklyScheduleIdForEdit').value = schedule.id;
                document.getElementById('scheduleFood').value = schedule.food;
                document.getElementById('scheduleDate').value = moment(schedule.schedule_date).format('jYYYY/jMM/jDD');
                document.getElementById('scheduleMealTime').value = schedule.meal_time;
                document.getElementById('scheduleCapacity1').value = schedule.capacity_nazry || '0';
                document.getElementById('scheduleCapacity2').value = schedule.capacity_foroshi || '0';
                document.getElementById('cookingAmount').value = schedule.cooking_amount || '0';
            }

            window.deleteWeeklySchedule = async function(scheduleId, foodName) {
                if (confirm(`آیا مطمئن هستید که می‌خواهید برنامه غذایی "${foodName}" را حذف کنید؟ این عمل غیرقابل بازگشت است.`)) {
                    const success = await deleteData(`${BASE_API_URL}weekly-schedule/${scheduleId}/`);
                    if (success) {
                        alert(`برنامه هفتگی برای "${foodName}" با موفقیت حذف شد.`);
                        loadWeeklyScheduleData();
                    }
                }
            }

            const weeklyDatePicker = document.getElementById('weekly-datepicker');
            if (weeklyDatePicker) {
                jalaliDatepicker.set
                (
                    {
                        selector: '#weekly-datepicker',
                        onlyMonthPicker: false,
                        persianDigit: true,
                        autoHide: true
                    }
                );
                weeklyDatePicker.addEventListener('change', (e) => {
                    const selectedDate = moment.from(e.target.value, 'fa', 'YYYY/MM/DD');
                    if (selectedDate.isValid()) {
                        loadWeeklyScheduleData(selectedDate);
                    }
                });
            }

            const saveWeeklyScheduleBtn = document.getElementById('saveWeeklyScheduleBtn');
            function toEnglishDigits(str) {
                if (!str) return '';
                return str.toString().replace(/[۰-۹]/g, d => String.fromCharCode(d.charCodeAt(0) - 1728))
                          .replace(/[٠-٩]/g, d => String.fromCharCode(d.charCodeAt(0) - 1632));
            }

            function showWeeklyScheduleError(msg) {
                let errDiv = document.getElementById('weeklyScheduleErrorMsg');
                if (!errDiv) {
                    errDiv = document.createElement('div');
                    errDiv.id = 'weeklyScheduleErrorMsg';
                    errDiv.style.color = 'red';
                    errDiv.style.textAlign = 'center';
                    errDiv.style.margin = '10px 0';
                    let form = document.querySelector('#add-weekly-schedule .form-container');
                    if (form) form.insertBefore(errDiv, form.firstChild);
                }
                errDiv.textContent = msg;
            }
            function clearWeeklyScheduleError() {
                let errDiv = document.getElementById('weeklyScheduleErrorMsg');
                if (errDiv) errDiv.textContent = '';
            }

           if (saveWeeklyScheduleBtn) {
    saveWeeklyScheduleBtn.addEventListener('click', async () => {
        clearWeeklyScheduleError();
        const foodId = document.getElementById('scheduleFood').value;
        const scheduleDateJalali = document.getElementById('scheduleDate').value;
        const mealTime = document.getElementById('scheduleMealTime').value;
        const capacityNazryValue = document.getElementById('scheduleCapacity1').value;
        const capacityForoshiValue = document.getElementById('scheduleCapacity2').value;
        const cookingAmountValue = document.getElementById('cookingAmount').value;

        // 1. اعتبارسنجی فیلدهای اصلی
        if (!foodId || !scheduleDateJalali || !mealTime) {
            showWeeklyScheduleError('لطفاً تمام فیلدهای الزامی (غذا، تاریخ و وعده غذایی) را پر کنید.');
            return;
        }

        // 2. تبدیل تاریخ جلالی به میلادی
        const momentDate = moment.from(toEnglishDigits(scheduleDateJalali), 'fa', 'YYYY/MM/DD');
        if (!momentDate.isValid()) {
            showWeeklyScheduleError('فرمت تاریخ وارد شده نامعتبر است. لطفاً از تقویم انتخاب کنید.');
            return;
        }
        const formattedScheduleDate = momentDate.format('YYYY-MM-DD');

        // 3. پردازش مقادیر عددی
        const nazry = capacityNazryValue ? parseInt(toEnglishDigits(capacityNazryValue)) : null;
        const foroshi = capacityForoshiValue ? parseInt(toEnglishDigits(capacityForoshiValue)) : null;
        const cooking = cookingAmountValue ? parseInt(toEnglishDigits(cookingAmountValue)) : null;

        if ((capacityNazryValue && isNaN(nazry)) || (capacityForoshiValue && isNaN(foroshi)) || (cookingAmountValue && isNaN(cooking))) {
            showWeeklyScheduleError('مقادیر ظرفیت و طبخ باید عدد معتبر باشند.');
            return;
        }

        const scheduleData = {
            food: parseInt(toEnglishDigits(foodId)),
            schedule_date: formattedScheduleDate,
            meal_time: mealTime,
            capacity_nazry: nazry,
            capacity_foroshi: foroshi,
            cooking_amount: cooking
        };

        let result = null;
        if (editingWeeklyScheduleId) {
            // حالت ویرایش
            result = await putData(`${BASE_API_URL}weekly-schedule/${editingWeeklyScheduleId}/`, scheduleData);
        } else {
            // حالت ایجاد جدید
            result = await postData(`${BASE_API_URL}weekly-schedule/`, scheduleData);
        }

        // اگر درخواست موفقیت‌آمیز بود و خطایی از سمت سرور (مثل 400 یا 500) وجود نداشت، result مقدار خواهد داشت
        if (result) {
            alert('عملیات با موفقیت انجام شد!');
            clearWeeklyScheduleForm();
            showSection('weekly-schedule');
        }
        // نیازی به بلوک else نیست، چون توابع postData و putData خودشان در صورت خطا به کاربر هشدار می‌دهند.
    });
}
        });


        function getCategoryTagClass(categoryName) {
            if (!categoryName) return 'other';
            const lowerCaseName = categoryName.toLowerCase();
            if (lowerCaseName.includes('ایرانی')) return 'iranian';
            if (lowerCaseName.includes('خورشت')) return 'stew';
            if (lowerCaseName.includes('پروتئین')) return 'protein';
            if (lowerCaseName.includes('غلات')) return 'grains';
            if (lowerCaseName.includes('روغن') || lowerCaseName.includes('چربی')) return 'oil';
            if (lowerCaseName.includes('سبزیجات')) return 'vegetables';
            if (lowerCaseName.includes('ادویه')) return 'spices';
            if (lowerCaseName.includes('لبنیات')) return 'dairy';
            if (lowerCaseName.includes('گوشت')) return 'meat';
            if (lowerCaseName.includes('دریایی')) return 'seafood';
            if (lowerCaseName.includes('میوه')) return 'fruit';
            if (lowerCaseName.includes('دسر')) return 'dessert-tag';
            if (lowerCaseName.includes('نوشیدنی')) return 'drink';
            return 'other';
        }
        function getFoodTypeDisplay(foodType) {
            switch(foodType) {
                case 'main':
                    return 'غذای اصلی';
                case 'appetizer':
                    return 'پیش غذا';
                case 'dessert':
                    return 'دسر';
                default:
                    return 'نامشخص';
            }
        }
            async function handleSaveWeeklySchedule() {
        const errorDiv = document.getElementById('form-error-message');
        errorDiv.textContent = ''; // پاک کردن خطای قبلی

        // ۱. جمع‌آوری داده‌ها از فرم
        const foodId = document.getElementById('scheduleFood').value;
        const scheduleDateJalali = document.getElementById('scheduleDate').value;
        const mealTime = document.getElementById('scheduleMealTime').value;
        const capacityNazry = document.getElementById('scheduleCapacity1').value;
        const capacityForoshi = document.getElementById('scheduleCapacity2').value;
        const cookingAmount = document.getElementById('cookingAmount').value;
        const scheduleId = document.getElementById('weeklyScheduleIdForEdit').value;

        // ۲. اعتبارسنجی اولیه
        if (!foodId || !scheduleDateJalali || !mealTime) {
            errorDiv.textContent = 'لطفاً تمام فیلدهای الزامی (غذا، تاریخ و وعده غذایی) را پر کنید.';
            return;
        }

        // ۳. پردازش و تبدیل تاریخ (بسیار مهم)
        // تابعی برای تبدیل اعداد فارسی/عربی به انگلیسی
        const toEnglishDigits = (str) => {
            if (!str) return '';
            return str.toString().replace(/[۰-۹]/g, d => String.fromCharCode(d.charCodeAt(0) - 1728))
                      .replace(/[٠-٩]/g, d => String.fromCharCode(d.charCodeAt(0) - 1632));
        };

        const englishDate = toEnglishDigits(scheduleDateJalali);
        const momentDate = moment.from(englishDate, 'fa', 'YYYY/MM/DD');

        if (!momentDate.isValid()) {
            errorDiv.textContent = 'فرمت تاریخ وارد شده نامعتبر است. لطفاً از تقویم انتخاب کنید.';
            return;
        }
        const formattedScheduleDate = momentDate.format('YYYY-MM-DD');

        // ۴. ساختار نهایی داده برای ارسال به سرور
        const scheduleData = {
            food: parseInt(foodId),
            schedule_date: formattedScheduleDate,
            meal_time: mealTime,
            // اطمینان از اینکه مقادیر خالی به عنوان null ارسال شوند
            capacity_nazry: capacityNazry ? parseInt(toEnglishDigits(capacityNazry)) : null,
            capacity_foroshi: capacityForoshi ? parseInt(toEnglishDigits(capacityForoshi)) : null,
            cooking_amount: cookingAmount ? parseInt(toEnglishDigits(cookingAmount)) : null,
        };

        // نمایش داده نهایی در کنسول برای خطایابی
        console.log('داده ارسالی به سرور:', scheduleData);

        try {
            let result = null;
            if (scheduleId) {
                // حالت ویرایش
                console.log(`ارسال درخواست PUT برای ویرایش ID: ${scheduleId}`);
                result = await putData(`${BASE_API_URL}weekly-schedule/${scheduleId}/`, scheduleData);
            } else {
                // حالت ایجاد
                console.log('ارسال درخواست POST برای ایجاد برنامه جدید');
                result = await postData(`${BASE_API_URL}weekly-schedule/`, scheduleData);
            }

            // ۵. مدیریت پاسخ سرور
            if (result) {
                alert('برنامه هفتگی با موفقیت ذخیره شد!');
                // پاک کردن فرم در تابع showSection انجام می‌شود
                showSection('weekly-schedule');
            } else {
                // این پیام فقط در صورتی نمایش داده می‌شود که سرور پاسخ موفقیت‌آمیز اما خالی برگرداند
                // در حالت عادی، توابع postData/putData خودشان خطای سرور را alert می‌کنند
                errorDiv.textContent = 'سرور پاسخی برنگرداند اما خطایی نیز گزارش نشد. لطفاً صفحه را رفرش کرده و دوباره تلاش کنید.';
            }
        } catch (error) {
            console.error('یک خطای غیرمنتظره در جاوا اسکریپت رخ داد:', error);
            errorDiv.textContent = 'یک خطای غیرمنتظره در سیستم رخ داد. لطفاً با پشتیبانی تماس بگیرید.';
        }
    }

    // اتصال تابع جدید به رویداد کلیک دکمه ذخیره
    document.addEventListener('DOMContentLoaded', () => {
        const saveBtn = document.getElementById('saveWeeklyScheduleBtn');
        if (saveBtn) {
            saveBtn.addEventListener('click', handleSaveWeeklySchedule);
        }
    });
    // یک متغیر سراسری برای نگهداری تاریخ هفته در حال نمایش
let currentScheduleDate = moment();

const mealTimeMap = {
    'breakfast': 'صبحانه',
    'lunch': 'ناهار',
    'dinner': 'شام',
    'snack': 'میان وعده'
};

const dayOfWeekMap = [
    'شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه'
];

function getStartOfWeek(date) {
    // در تقویم جلالی، شنبه روز اول هفته (day 6) است
    const day = moment(date).day();
    const diff = (day < 6) ? (day + 1) : (day - 6);
    return moment(date).subtract(diff, 'days').startOf('day');
}

// تابع اصلی بارگذاری داده‌ها، اکنون بدون آرگومان کار می‌کند و از متغیر سراسری استفاده می‌کند
window.loadWeeklyScheduleData = async function() {
    const startOfWeek = getStartOfWeek(currentScheduleDate);
    const endOfWeek = moment(startOfWeek).add(6, 'days');

    // نمایش بازه زمانی هفته در UI
    const weekDisplay = document.getElementById('currentWeekDisplay');
    if (weekDisplay) {
        weekDisplay.textContent = `
            ${startOfWeek.format('jDD jMMMM')} - ${endOfWeek.format('jDD jMMMM jYYYY')}
        `;
    }

    const url = `${BASE_API_URL}weekly-schedule/?start_date=${startOfWeek.format('YYYY-MM-DD')}&end_date=${endOfWeek.format('YYYY-MM-DD')}`;

    const schedules = await fetchData(url);
    if (!schedules) return;

    const groupedByDate = {};
    for (let i = 0; i < 7; i++) {
        const currentDay = moment(startOfWeek).add(i, 'days');
        const dateKey = currentDay.format('jYYYY/jMM/jDD');
        const dayName = dayOfWeekMap[i]; // شنبه تا جمعه
        groupedByDate[dateKey] = {
            dayName: dayName,
            date: currentDay.format('YYYY-MM-DD'),
            meals: []
        };
    }

    schedules.forEach(schedule => {
        const dateKey = moment(schedule.schedule_date).format('jYYYY/jMM/jDD');
        if (groupedByDate[dateKey]) {
            groupedByDate[dateKey].meals.push(schedule);
        }
    });

    renderWeeklyScheduleGrid(groupedByDate);
}

// این تابع بدون تغییر باقی می‌ماند
function renderWeeklyScheduleGrid(groupedData) {
    const gridContainer = document.getElementById('weeklyScheduleGrid');
    gridContainer.innerHTML = '';

    Object.keys(groupedData).forEach(dateKey => {
        const dayData = groupedData[dateKey];
        const dayCard = document.createElement('div');
        dayCard.classList.add('day-card');

        let mealsHtml = '';
        if (dayData.meals.length > 0) {
            mealsHtml = dayData.meals.map(meal => `
                <li>
                    <div class="meal-time-title">${mealTimeMap[meal.meal_time]}</div>
                    <div class="meal-info">
                        <span class="food-name">${meal.food_name}</span>
                        <span>(حضرتی: ${meal.capacity_nazry || '۰'}, فروشی: ${meal.capacity_foroshi || '۰'})</span>
                    </div>
                    <div class="meal-actions">
                        <button onclick="editWeeklySchedule(${meal.id})"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteWeeklySchedule(${meal.id}, '${meal.food_name}')"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </li>
            `).join('');
        } else {
            mealsHtml = '<li><small>برنامه‌ای برای این روز ثبت نشده است.</small></li>';
        }

        dayCard.innerHTML = `
            <h4>${dayData.dayName} <br> <small>${dateKey}</small></h4>
            <ul class="meal-list">
                ${mealsHtml}
            </ul>
        `;
        gridContainer.appendChild(dayCard);
    });
}

// این توابع بدون تغییر باقی می‌مانند
window.editWeeklySchedule = async function(scheduleId) {
    showSection('add-weekly-schedule');
    const schedule = await fetchData(`${BASE_API_URL}weekly-schedule/${scheduleId}/`);
    if (!schedule) return;

    // ست کردن ID برای ویرایش
    document.getElementById('weeklyScheduleIdForEdit').value = schedule.id;
    document.getElementById('scheduleFood').value = schedule.food;
    document.getElementById('scheduleDate').value = moment(schedule.schedule_date).format('jYYYY/jMM/jDD');
    document.getElementById('scheduleMealTime').value = schedule.meal_time;
    document.getElementById('scheduleCapacity1').value = schedule.capacity_nazry || '0';
    document.getElementById('scheduleCapacity2').value = schedule.capacity_foroshi || '0';
    document.getElementById('cookingAmount').value = schedule.cooking_amount || '0';
}

window.deleteWeeklySchedule = async function(scheduleId, foodName) {
    if (confirm(`آیا مطمئن هستید که می‌خواهید برنامه غذایی "${foodName}" را حذف کنید؟`)) {
        const success = await deleteData(`${BASE_API_URL}weekly-schedule/${scheduleId}/`);
        if (success) {
            alert(`برنامه هفتگی برای "${foodName}" با موفقیت حذف شد.`);
            loadWeeklyScheduleData(); // بازخوانی هفته فعلی
        }
    }
}


// اتصال رویدادها به دکمه‌ها و تقویم در زمان بارگذاری کامل صفحه
document.addEventListener('DOMContentLoaded', () => {
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const weeklyDatePicker = document.getElementById('weekly-datepicker');

    if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', () => {
            currentScheduleDate.subtract(7, 'days');
            loadWeeklyScheduleData();
        });
    }

    if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', () => {
            currentScheduleDate.add(7, 'days');
            loadWeeklyScheduleData();
        });
    }

    if (weeklyDatePicker) {
         jalaliDatepicker.set({
            selector: '#weekly-datepicker',
            persianDigit: true,
            autoHide: true
        });
        weeklyDatePicker.addEventListener('change', (e) => {
            // تبدیل تاریخ انتخابی از تقویم به فرمت moment
             const toEnglish = str => str.toString().replace(/[۰-۹]/g, d => String.fromCharCode(d.charCodeAt(0) - 1728));
             const selectedDate = moment.from(toEnglish(e.target.value), 'fa', 'YYYY/MM/DD');
            if (selectedDate.isValid()) {
                currentScheduleDate = selectedDate; // به‌روزرسانی تاریخ سراسری
                loadWeeklyScheduleData(); // بارگذاری داده‌ها برای هفته جدید
            }
        });
    }
});

// در نهایت، تابع showSection را کمی تغییر می‌دهیم تا با ورود به صفحه، همیشه هفته جاری نمایش داده شود
function showSection(sectionId) {
    // ... کدهای قبلی این تابع سر جای خود باقی می‌مانند ...
    sidebarLinks.forEach(link => link.classList.remove('active'));
    contentSections.forEach(section => section.classList.remove('active'));

    const targetLink = document.querySelector(`.sidebar-menu a[data-section="${sectionId}"]`);
    if (targetLink) {
        targetLink.classList.add('active');
    }
    document.getElementById(sectionId).classList.add('active');


    editingFoodId = null;
    editingRawMaterialId = null;
    // مهم: هنگام خروج از فرم ویرایش، آیدی را پاک می‌کنیم
    document.getElementById('weeklyScheduleIdForEdit').value = '';


    if (sectionId === 'dashboard') {
        loadDashboardData();
    } else if (sectionId === 'food-list') {
        loadFoodListData();
    } else if (sectionId === 'raw-material-management') {
        loadRawMaterialListData();
    } else if (sectionId === 'add-new-food') {
        clearFoodForm();
        populateFoodFormDropdowns();
    } else if (sectionId === 'add-new-raw-material') {
        clearRawMaterialForm();
        populateRawMaterialFormDropdowns();
    } else if (sectionId === 'weekly-schedule') {
        // با هر بار ورود به صفحه برنامه هفتگی، به هفته جاری برمیگردیم
        currentScheduleDate = moment();
        window.loadWeeklyScheduleData();
    } else if (sectionId === 'add-weekly-schedule') {
        // اگر در حال ویرایش نیستیم، فرم را پاک کن
        if (!document.getElementById('weeklyScheduleIdForEdit').value) {
             clearWeeklyScheduleForm();
        }
        window.populateScheduleFoodDropdown();
    }
}


        jalaliDatepicker.startWatch();

    </script>
</body>
</html>