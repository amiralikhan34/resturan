<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت رستوران</title>
    <meta name="description" content="سیستم جامع مدیریت رستوران برای سازماندهی غذاها، مواد اولیه و موجودی.">
    <meta name="keywords" content="مدیریت رستوران، غذا، مواد اولیه، موجودی، آشپزی">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    {# این متا تگ برای CSRF token است و توسط جنگو پر می‌شود #}
    <meta name="csrf-token" content="{{ csrf_token }}">

    <style>
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Medium.woff2') format('woff2');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/fonts/webfonts/Vazirmatn-Bold.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }


        * {
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            direction: rtl;
            overflow-x: hidden;
            color: #333;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #eee;
            flex-shrink: 0;
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }

        .sidebar-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: #555;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
        }

        .sidebar-menu a i {
            margin-left: 10px;
            font-size: 18px;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: #e8f5e9;
            color: #4CAF50;
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            background-color: #f4f6f9;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            color: #333;
        }

        .header .add-button {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .header .add-button:hover {
            background-color: #45a049;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-left: 15px;
            color: #fff;
        }

        .card-icon.purple { background-color: #9c27b0; }
        .card-icon.blue { background-color: #2196f3; }
        .card-icon.green { background-color: #4CAF50; }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #555;
        }

        .card-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
            text-align: center;
            margin-top: 10px;
        }

        .table-container {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: right;
            min-width: 600px;
        }

        th, td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        th {
            background-color: #f8f8f8;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }

        td {
            color: #666;
            font-size: 15px;
        }

        .table-actions button {
            background: none;
            border: none;
            cursor: pointer;
            margin-left: 8px;
            font-size: 18px;
            transition: color 0.2s;
        }

        .table-actions .edit-btn { color: #2196f3; }
        .table-actions .delete-btn { color: #f44336; }

        .table-actions .edit-btn:hover { color: #1976d2; }
        .table-actions .delete-btn:hover { color: #d32f2f; }

        .tag {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            margin-left: 5px;
        }

        .tag.iranian { background-color: #e8f5e9; color: #4CAF50; }
        .tag.stew { background-color: #ffe0b2; color: #fb8c00; }
        .tag.protein { background-color: #bbdefb; color: #2196f3; }
        .tag.grains { background-color: #c8e6c9; color: #4CAF50; }
        .tag.oil { background-color: #fff9c4; color: #ffeb3b; }
        .tag.vegetables { background-color: #dcedc8; color: #8bc34a; }
        .tag.spices { background-color: #f8bbd0; color: #e91e63; }

        .food-sizes span {
            display: inline-block;
            padding: 4px 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            margin-left: 5px;
            font-size: 13px;
            color: #777;
            white-space: nowrap;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .chart-card h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #4CAF50;
            font-size: 18px;
            font-weight: bold;
        }

        .material-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 15px;
        }

        .material-item .color-box {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-left: 10px;
            flex-shrink: 0;
        }

        .material-item .quantity {
            font-weight: bold;
            margin-left: 5px;
            color: #4CAF50;
            white-space: nowrap;
        }

        .material-item .description {
            color: #666;
        }

        .progress-bar-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            height: 10px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }

        .progress-bar.green { background-color: #4CAF50; }
        .progress-bar.orange { background-color: #ff9800; }
        .progress-bar.red { background-color: #f44336; }

        .progress-text {
            font-size: 14px;
            color: #555;
            margin-top: 10px;
            text-align: right;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #4CAF50;
            outline: none;
        }

        .form-group.inline-group {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .form-group.inline-group > div {
            flex: 1;
            min-width: 200px;
        }

        .form-group.inline-group label {
            margin-bottom: 5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-left: 10px;
            width: 20px;
            height: 20px;
            transform: scale(1.2);
            accent-color: #4CAF50;
            cursor: pointer;
        }

        .add-material-btn {
            background-color: #4CAF50;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s;
            margin-bottom: 20px;
            white-space: nowrap;
        }

        .add-material-btn:hover {
            background-color: #45a049;
        }

        .raw-materials-list .material-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
            flex-wrap: wrap;
        }

        .raw-materials-list .material-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .raw-materials-list .material-row > div {
            flex: 1;
            min-width: 120px;
        }
        .raw-materials-list .material-row > div:first-child {
             min-width: 150px;
        }


        .raw-materials-list .material-row .actions {
            flex: 0 0 40px;
            text-align: center;
            align-self: center;
        }

        .raw-materials-list .material-row input,
        .raw-materials-list .material-row select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            box-sizing: border-box;
        }

        .raw-materials-list .material-row .delete-material-btn {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }

        .raw-materials-list .material-row .delete-material-btn:hover {
            color: #d32f2f;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .form-actions button {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-weight: 500;
            white-space: nowrap;
        }

        .form-actions .save-btn {
            background-color: #4CAF50;
            color: #fff;
            border: none;
        }

        .form-actions .save-btn:hover {
            background-color: #45a049;
        }

        .form-actions .cancel-btn {
            background-color: #f0f0f0;
            color: #666;
            border: 1px solid #ccc;
        }

        .form-actions .cancel-btn:hover {
            background-color: #e0e0e0;
        }

        .food-item-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        .food-item-card h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
            font-size: 20px;
        }
        .food-item-card .details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 14px;
            color: #777;
        }
        .food-item-card .details span {
            display: flex;
            align-items: center;
        }
        .food-item-card .details i {
            margin-left: 5px;
            color: #555;
        }
        .food-item-card .main-materials {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .food-item-card .main-materials span {
            display: inline-block;
            background-color: #e3f2fd;
            color: #1e88e5;
            padding: 6px 12px;
            border-radius: 6px;
            margin-left: 8px;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
        }
        .food-item-card .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
        }
        .food-item-card .card-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .food-item-card .card-actions .edit-btn { color: #2196f3; }
        .food-item-card .card-actions .delete-btn { color: #f44336; }
        .food-item-card .card-actions .edit-btn:hover { background-color: #e3f2fd; }
        .food-item-card .card-actions .delete-btn:hover { background-color: #ffebee; }

        .search-filter-bar {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            background-color: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            flex-wrap: wrap;
        }

        .search-filter-bar .search-input {
            flex-grow: 1;
            position: relative;
            min-width: 180px;
        }

        .search-filter-bar .search-input input {
            width: 100%;
            padding: 10px 15px;
            padding-right: 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            box-sizing: border-box;
        }

        .search-filter-bar .search-input i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .search-filter-bar .filter-dropdown select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
            font-size: 16px;
            font-family: 'Vazirmatn', sans-serif;
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23888888" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: left 10px center;
            padding-left: 35px;
            min-width: 150px;
            box-sizing: border-box;
        }

        .search-filter-bar .filter-dropdown {
            position: relative;
        }

        .search-filter-bar .add-button {
            padding: 10px 15px;
            font-size: 14px;
            gap: 5px;
            order: -1;
        }

        .raw-material-item-card {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }
        .raw-material-item-card .info {
            flex-grow: 1;
            margin-bottom: 10px;
        }
        .raw-material-item-card h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        .raw-material-item-card .details {
            font-size: 14px;
            color: #777;
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px 10px;
        }
        .raw-material-item-card .details span {
            white-space: nowrap;
        }
        .raw-material-item-card .actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        .raw-material-item-card .actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            margin-left: 0;
            transition: color 0.2s;
            padding: 5px;
        }
        .raw-material-item-card .actions .edit-btn { color: #2196f3; }
        .raw-material-item-card .actions .delete-btn { color: #f44336; }
        .raw-material-item-card .actions .edit-btn:hover { color: #1976d2; }
        .raw-material-item-card .actions .delete-btn:hover { color: #d32f2f; }


        .user-profile {
            display: flex;
            align-items: center;
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #eee;
            gap: 15px;
        }

        .user-profile .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #c8e6c9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #4CAF50;
            flex-shrink: 0;
        }

        .user-profile .user-info {
            flex-grow: 1;
        }

        .user-profile .user-info .name {
            font-weight: bold;
            font-size: 16px;
            color: #333;
        }

        .user-profile .user-info .role {
            font-size: 13px;
            color: #777;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                padding: 15px;
                flex-direction: row;
                justify-content: center;
                border-left: none;
                border-bottom: 1px solid #eee;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .sidebar-header {
                display: none;
            }
            .sidebar-menu ul {
                display: flex;
                flex-wrap: nowrap;
                justify-content: flex-start;
                gap: 5px;
                padding-bottom: 10px;
            }
            .sidebar-menu li {
                margin-bottom: 0;
                flex-shrink: 0;
            }
            .sidebar-menu a {
                padding: 10px 12px;
                font-size: 14px;
            }
            .sidebar-menu a i {
                font-size: 16px;
            }
            .user-profile {
                display: none;
            }
            .main-content {
                padding: 20px;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .cards-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .header h1 {
                font-size: 24px;
            }
            .header .add-button {
                width: 100%;
                justify-content: center;
                padding: 10px 15px;
            }

            .form-container {
                padding: 15px;
            }
            .form-group.inline-group {
                flex-direction: column;
                gap: 15px;
            }
            .raw-materials-list .material-row {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding-bottom: 15px;
            }
            .raw-materials-list .material-row > div {
                width: 100%;
                min-width: unset;
            }
            .raw-materials-list .material-row .actions {
                text-align: right;
                width: 100%;
            }
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            .form-actions button {
                width: 100%;
            }

            .search-filter-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 10px 15px;
            }
            .search-filter-bar .search-input {
                width: 100%;
                min-width: unset;
            }
            .search-filter-bar .search-input input {
                 padding-right: 15px;
                 padding-left: 15px;
            }
            .search-filter-bar .search-input i {
                left: unset;
                right: 15px;
            }
            .search-filter-bar .filter-dropdown {
                width: 100%;
                min-width: unset;
            }
            .search-filter-bar .filter-dropdown select {
                width: 100%;
                padding-left: 15px;
                background-position: left 15px center;
            }
            .search-filter-bar .add-button {
                width: 100%;
                order: -1;
                justify-content: center;
            }

            .raw-material-item-card {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 20px;
            }
            .raw-material-item-card .info {
                margin-bottom: 0;
            }
            .raw-material-item-card .actions {
                justify-content: flex-end;
                width: 100%;
            }
            .raw-material-item-card .details {
                flex-direction: column;
                gap: 5px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }
            .cards-container {
                grid-template-columns: 1fr;
            }
            .card {
                padding: 20px;
            }
            .card-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                margin-bottom: 10px;
            }
            .card-icon {
                margin-left: 0;
                margin-bottom: 10px;
            }
            .table-container {
                padding: 15px;
            }
            th, td {
                padding: 10px;
                font-size: 14px;
            }
            .food-item-card {
                padding: 15px;
            }
            .food-item-card h3 {
                font-size: 18px;
            }
            .food-item-card .details span,
            .food-item-card .main-materials span {
                font-size: 12px;
                padding: 4px 8px;
            }
            .raw-material-item-card {
                padding: 15px;
            }
            .raw-material-item-card h3 {
                font-size: 16px;
            }
            .raw-material-item-card .details span {
                font-size: 12px;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">مدیریت رستوران</div>
            <nav class="sidebar-menu">
                <ul>
                    <li><a href="#" data-section="dashboard" class="active"><i class="fas fa-tachometer-alt"></i> داشبورد</a></li>
                    <li><a href="#" data-section="food-list"><i class="fas fa-utensils"></i> لیست غذاها</a></li>
                    <li><a href="#" data-section="add-new-food"><i class="fas fa-plus-circle"></i> تعریف غذای جدید</a></li>
                    <li><a href="#" data-section="raw-material-management"><i class="fas fa-boxes"></i> مدیریت مواد اولیه</a></li>
                </ul>
            </nav>
            <div class="user-profile">
                <div class="avatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <div class="name">سعید عبدالحسینی</div>
                    <div class="role">مدیر سیستم</div>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <section id="dashboard" class="content-section active">
                <div class="header">
                    <h1>داشبورد مدیریت</h1>
                    <button class="add-button" onclick="showSection('add-new-food')"><i class="fas fa-plus"></i> غذاي جدید</button>
                </div>

                <div class="cards-container">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon purple"><i class="fas fa-tags"></i></div>
                            <span class="card-title">دسته بندی ها</span>
                        </div>
                        <div class="card-value" id="dashboard-total-categories">۰</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon blue"><i class="fas fa-box-open"></i></div>
                            <span class="card-title">مواد اولیه</span>
                        </div>
                        <div class="card-value" id="dashboard-total-raw-materials">۰</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon green"><i class="fas fa-utensils"></i></div>
                            <span class="card-title">تعداد غذاها</span>
                        </div>
                        <div class="card-value" id="dashboard-total-foods">۰</div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-main-area">
                        <div class="table-container" style="margin-bottom: 20px;">
                            <h2>لیست غذاها</h2>
                            <table id="dashboardFoodTable">
                                <thead>
                                    <tr>
                                        <th>نام غذا</th>
                                        <th>دسته بندی</th>
                                        <th>تعداد مواد اولیه</th>
                                        <th>سایزها</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>

                        <div class="chart-card">
                            <h3>ساختار چلو کباب کوبیده</h3>
                            <div id="kabobStructureList">
                                </div>
                        </div>
                    </div>

                    <div class="dashboard-charts-area">
                        <div class="chart-card">
                            <h3>مواد اولیه پرمصرف</h3>
                            <div id="topConsumedMaterialsList">
                                </div>
                        </div>

                        <div class="chart-card">
                            <h3>وضعیت موجودی</h3>
                            <div id="stockStatusList">
                                </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="food-list" class="content-section">
                <div class="header">
                    <h1>لیست غذاها</h1>
                    <button class="add-button" onclick="showSection('add-new-food')"><i class="fas fa-plus"></i> غذای جدید</button>
                </div>
                <div class="search-filter-bar">
                    <button class="add-button" onclick="showSection('add-new-food')"><i class="fas fa-plus"></i> غذای جدید</button>
                    <div class="filter-dropdown">
                        <select id="foodListCategoryFilter">
                            <option value="">همه دسته‌بندی‌ها</option>
                            </select>
                    </div>
                    <div class="search-input">
                        <input type="text" id="foodListSearchInput" placeholder="جستجو در غذاها...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <div class="food-list-cards" id="foodListCardsContainer">
                    </div>
            </section>

            <section id="add-new-food" class="content-section">
                <div class="header">
                    <h1>تعریف غذای جدید</h1>
                    <button class="add-button" onclick="showSection('food-list')"><i class="fas fa-arrow-right"></i> بازگشت به لیست</button>
                </div>
                <div class="form-container">
                    <h2>اطلاعات پایه</h2>
                    <div class="form-group inline-group">
                        <div>
                            <label for="foodName">نام غذا</label>
                            <input type="text" id="foodName" placeholder="مثال: چلو کباب کوبیده" required>
                        </div>
                        <div>
                            <label for="foodCategory">دسته بندی</label>
                            <select id="foodCategory" required>
                                </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>سایزهای موجود</label>
                        <div class="checkbox-group" id="foodSizeCheckboxes">
                            </div>
                    </div>

                    <div class="form-group">
                        <label for="foodDescription">توضیحات</label>
                        <textarea id="foodDescription" rows="4" placeholder="توضیحات مختصر درباره غذا..."></textarea>
                    </div>

                    <h2 style="margin-top: 30px; margin-bottom: 20px;">مواد اولیه</h2>
                    <button class="add-material-btn" id="addFoodMaterialBtn"><i class="fas fa-plus"></i> افزودن ماده اولیه</button>
                    <div class="raw-materials-list" id="foodMaterialsList">
                        </div>

                    <div class="form-actions">
                        <button class="save-btn" id="saveFoodBtn"><i class="fas fa-save"></i> ذخیره غذا</button>
                        <button class="cancel-btn" onclick="showSection('food-list')"><i class="fas fa-times-circle"></i> انصراف</button>
                    </div>
                </div>
            </section>

            <section id="raw-material-management" class="content-section">
                <div class="header">
                    <h1>مدیریت مواد اولیه</h1>
                    <button class="add-button" onclick="showAddRawMaterialForm()"><i class="fas fa-plus"></i> افزودن ماده اولیه جدید</button>
                </div>
                <div class="search-filter-bar">
                    <button class="add-button" onclick="showAddRawMaterialForm()"><i class="fas fa-plus"></i> افزودن ماده اولیه جدید</button>
                    <div class="filter-dropdown">
                        <select id="rawMaterialListCategoryFilter">
                            <option value="">فیلتر</option>
                            </select>
                    </div>
                    <div class="search-input">
                        <input type="text" id="rawMaterialListSearchInput" placeholder="جستجو در مواد اولیه...">
                        <i class="fas fa-search"></i>
                    </div>
                </div>

                <div class="raw-material-list-cards" id="rawMaterialListCardsContainer">
                    </div>

                <div class="dashboard-charts-area" style="margin-top: 30px;">
                    <div class="chart-card">
                        <h3>مواد اولیه پرمصرف</h3>
                        <div id="rawMaterialTopConsumedList">
                            </div>
                    </div>

                    <div class="chart-card">
                        <h3>وضعیت موجودی</h3>
                        <div id="rawMaterialStockStatusList">
                            </div>
                    </div>
                </div>
            </section>

            <section id="add-new-raw-material" class="content-section">
                <div class="header">
                    <h1>افزودن ماده اولیه جدید</h1>
                    <button class="add-button" onclick="showSection('raw-material-management')"><i class="fas fa-arrow-right"></i> بازگشت</button>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="rawMaterialName">نام ماده اولیه</label>
                        <input type="text" id="rawMaterialName" placeholder="مثال: زعفران" required>
                    </div>
                    <div class="form-group inline-group">
                        <div>
                            <label for="rawMaterialCategory">دسته بندی</label>
                            <select id="rawMaterialCategory" required>
                                </select>
                        </div>
                        <div>
                            <label for="rawMaterialUnit">واحد اندازه‌گیری</label>
                            <select id="rawMaterialUnit" required>
                                <option value="gram">گرم</option>
                                <option value="kg">کیلوگرم</option>
                                <option value="milliliter">میلی لیتر</option>
                                <option value="liter">لیتر</option>
                                <option value="piece">عدد</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="rawMaterialStock">موجودی اولیه</label>
                        <input type="number" id="rawMaterialStock" value="0" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="rawMaterialDescription">توضیحات</label>
                        <textarea id="rawMaterialDescription" rows="4" placeholder="توضیحات اضافی درباره این ماده اولیه..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button class="save-btn" id="saveRawMaterialBtn"><i class="fas fa-save"></i> ذخیره ماده اولیه</button>
                        <button class="cancel-btn" onclick="showSection('raw-material-management')"><i class="fas fa-times-circle"></i> انصراف</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const BASE_API_URL = 'http://127.0.0.1:8000/api/'; // Your Django API base URL

        // --- Helper Functions for API Calls ---
        async function fetchData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text(); // Get raw text to help debug
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching from ${url}:`, error);
                alert(`خطا در بارگذاری داده‌ها از سرور: ${error.message}`);
                return null;
            }
        }

        // Helper for getting CSRF token from meta tag
        function getCsrfToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            if (meta) {
                return meta.getAttribute('content');
            }
            return null; // Return null if not found
        }

        async function postData(url, data) {
            const csrftoken = getCsrfToken(); // دریافت توکن CSRF
            if (!csrftoken) {
                console.error('CSRF token not found. Aborting POST request.');
                alert('خطا: CSRF token یافت نشد. نمی‌توان داده را ارسال کرد. لطفاً صفحه را رفرش کنید.');
                return null;
            }
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken, // ارسال توکن در هدر
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${JSON.stringify(errorData)}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error posting to ${url}:`, error);
                alert(`خطا در ارسال داده به سرور: ${error.message}`);
                return null;
            }
        }

        async function deleteData(url) {
            const csrftoken = getCsrfToken(); // دریافت توکن CSRF
            if (!csrftoken) {
                console.error('CSRF token not found. Aborting DELETE request.');
                alert('خطا: CSRF token یافت نشد. نمی‌توان داده را حذف کرد. لطفاً صفحه را رفرش کنید.');
                return null;
            }
            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': csrftoken, // ارسال توکن در هدر
                    },
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorText}`);
                }
                return true;
            } catch (error) {
                console.error(`Error deleting from ${url}:`, error);
                alert(`خطا در حذف داده از سرور: ${error.message}`);
                return false;
            }
        }

        async function putData(url, data) {
            const csrftoken = getCsrfToken(); // دریافت توکن CSRF
            if (!csrftoken) {
                console.error('CSRF token not found. Aborting PUT request.');
                alert('خطا: CSRF token یافت نشد. نمی‌توان داده را به‌روزرسانی کرد. لطفاً صفحه را رفرش کنید.');
                return null;
            }
            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken, // ارسال توکن در هدر
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! Status: ${response.status}, Details: ${JSON.stringify(errorData)}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error updating data to ${url}:`, error);
                alert(`خطا در به‌روزرسانی داده: ${error.message}`);
                return null;
            }
        }


        // --- UI Navigation and Rendering Functions ---
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const contentSections = document.querySelectorAll('.content-section');

        function showSection(sectionId) {
            sidebarLinks.forEach(link => link.classList.remove('active'));
            contentSections.forEach(section => section.classList.remove('active'));

            const targetLink = document.querySelector(`.sidebar-menu a[data-section="${sectionId}"]`);
            if (targetLink) {
                targetLink.classList.add('active');
            }
            document.getElementById(sectionId).classList.add('active');

            // Load data specific to the section
            if (sectionId === 'dashboard') {
                loadDashboardData();
            } else if (sectionId === 'food-list') {
                loadFoodListData();
            } else if (sectionId === 'raw-material-management') {
                loadRawMaterialListData();
                loadDashboardCharts();
            } else if (sectionId === 'add-new-food') {
                populateFoodFormDropdowns();
            } else if (sectionId === 'add-new-raw-material') {
                populateRawMaterialFormDropdowns();
            }
        }

        window.showAddRawMaterialForm = function() {
            showSection('add-new-raw-material');
        }

        // --- Dashboard Data Loading & Rendering ---
        async function loadDashboardData() {
            const data = await fetchData(`${BASE_API_URL}dashboard-stats/`);
            if (!data) return;

            document.getElementById('dashboard-total-categories').textContent = data.total_categories;
            document.getElementById('dashboard-total-raw-materials').textContent = data.total_raw_materials;
            document.getElementById('dashboard-total-foods').textContent = data.total_foods;

            // Render Dashboard Food Table (simplified, shows actual foods)
            const foods = await fetchData(`${BASE_API_URL}foods/`);
            if (foods) {
                renderDashboardFoodTable(foods);
            }

            // Render Kabob Structure
            const kabobStructureList = document.getElementById('kabobStructureList');
            kabobStructureList.innerHTML = '';
            if (data.example_food_structure && data.example_food_structure.length > 0) {
                data.example_food_structure.forEach(item => {
                    const div = document.createElement('div');
                    div.classList.add('material-item');
                    div.innerHTML = `<div class="quantity">${item.quantity}</div><div class="description">${item.description}</div>`;
                    kabobStructureList.appendChild(div);
                });
            } else {
                 kabobStructureList.innerHTML = '<p>ساختار غذایی برای "چلو کباب کوبیده" یافت نشد.</p>';
            }


            // Render Top Consumed Materials
            const topConsumedMaterialsList = document.getElementById('topConsumedMaterialsList');
            topConsumedMaterialsList.innerHTML = '';
            if (data.top_consumed_materials) {
                const colors = ['#c8e6c9', '#ffccbc', '#fff9c4']; // Example colors
                data.top_consumed_materials.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.classList.add('material-item');
                    div.innerHTML = `
                        <div class="color-box" style="background-color: ${colors[index % colors.length]};"></div>
                        <div class="quantity">${item.total_needed} ${item.raw_material__unit_of_measurement}</div>
                        <div class="description">${item.raw_material__name} <small> (مقدار کل لازم در دستور پخت‌ها)</small></div>
                    `;
                    topConsumedMaterialsList.appendChild(div);
                });
            } else {
                topConsumedMaterialsList.innerHTML = '<p>اطلاعات مواد اولیه پرمصرف موجود نیست.</p>';
            }


            // Render Stock Status
            const stockStatusList = document.getElementById('stockStatusList');
            stockStatusList.innerHTML = '';
            if (data.stock_status) {
                data.stock_status.forEach(item => {
                    const div = document.createElement('div');
                    let progressColorClass = 'green';
                    if (item.percentage < 30) {
                        progressColorClass = 'red';
                    } else if (item.percentage < 70) {
                        progressColorClass = 'orange';
                    }
                    div.innerHTML = `
                        <div class="progress-text">
                            <span>${item.name}</span>
                            <span>${item.percentage}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressColorClass}" style="width: ${item.percentage}%;"></div>
                        </div>
                    `;
                    stockStatusList.appendChild(div);
                });
            } else {
                stockStatusList.innerHTML = '<p>اطلاعات وضعیت موجودی موجود نیست.</p>';
            }
        }

        // Helper for rendering food table on Dashboard
        function renderDashboardFoodTable(foods) {
            const tbody = document.querySelector('#dashboardFoodTable tbody');
            tbody.innerHTML = ''; // Clear existing rows

            if (foods && foods.length > 0) {
                foods.forEach(food => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${food.name}</td>
                        <td><span class="tag ${getCategoryTagClass(food.category_name)}">${food.category_name}</span></td>
                        <td>${food.raw_materials_count}</td>
                        <td>${food.available_sizes.map(s => `<span class="food-sizes">${s.name}</span>`).join(', ')}</td>
                        <td class="table-actions">
                            <button class="edit-btn" data-food-id="${food.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-food-id="${food.id}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    // Add event listeners for edit/delete buttons if needed here (for dashboard table)
                    // For now, these are illustrative and primarily for the main food-list section
                });
            } else {
                const row = tbody.insertRow();
                row.innerHTML = '<td colspan="5" style="text-align: center;">هیچ غذایی برای نمایش وجود ندارد.</td>';
            }
        }


        // --- Food List Data Loading & Rendering ---
        async function loadFoodListData(categoryId = '', searchQuery = '') {
            let url = `${BASE_API_URL}foods/`;
            const params = new URLSearchParams();
            if (categoryId) params.append('category_id', categoryId);
            if (searchQuery) params.append('search', searchQuery);
            if (params.toString()) url += `?${params.toString()}`;

            const foods = await fetchData(url);
            if (!foods) return;

            const foodListCardsContainer = document.getElementById('foodListCardsContainer');
            foodListCardsContainer.innerHTML = ''; // Clear existing cards

            if (foods.length > 0) {
                foods.forEach(food => {
                    const card = document.createElement('div');
                    card.classList.add('food-item-card');
                    card.innerHTML = `
                        <h3>${food.name}</h3>
                        <div class="details">
                            <span class="tag ${getCategoryTagClass(food.category_name)}">${food.category_name}</span>
                            <span><i class="fas fa-boxes"></i> تعداد مواد اولیه: ${food.raw_materials_count}</span>
                            <span><i class="fas fa-utensils"></i> سایزها: ${food.available_sizes.map(s => s.name).join(', ')}</span>
                        </div>
                        <div class="main-materials">
                            ${food.main_materials.map(material => `<span>${material}</span>`).join('')}
                        </div>
                        <div class="card-actions">
                            <button class="edit-btn" data-food-id="${food.id}"><i class="fas fa-edit"></i> ویرایش</button>
                            <button class="delete-btn" data-food-id="${food.id}"><i class="fas fa-trash-alt"></i> حذف</button>
                        </div>
                    `;
                    foodListCardsContainer.appendChild(card);

                    // Add event listeners for edit and delete buttons
                    card.querySelector('.edit-btn').addEventListener('click', () => editFood(food.id));
                    card.querySelector('.delete-btn').addEventListener('click', () => deleteFood(food.id, food.name));
                });
            } else {
                foodListCardsContainer.innerHTML = '<p style="text-align: center;">هیچ غذایی با این فیلترها یافت نشد.</p>';
            }
        }

        async function editFood(foodId) {
            alert(`ویرایش غذا با ID: ${foodId} (این قابلیت هنوز پیاده سازی نشده و نیاز به بارگذاری فرم با داده ها دارد)`);
            // In a real app:
            // 1. Fetch food details: await fetchData(`${BASE_API_URL}foods/${foodId}/`);
            // 2. Populate the 'add-new-food' form with these details.
            // 3. Change 'save' button to 'update' button logic.
            // 4. showSection('add-new-food');
        }

        async function deleteFood(foodId, foodName) {
            if (confirm(`آیا از حذف غذای "${foodName}" مطمئن هستید؟`)) {
                const success = await deleteData(`${BASE_API_URL}foods/${foodId}/`);
                if (success) {
                    alert(`غذای "${foodName}" با موفقیت حذف شد.`);
                    loadFoodListData(); // Reload the list after deletion
                }
            }
        }

        // --- Raw Material List Data Loading & Rendering ---
        async function loadRawMaterialListData(categoryId = '', searchQuery = '') {
            let url = `${BASE_API_URL}raw-materials/`;
            const params = new URLSearchParams();
            if (categoryId) params.append('category_id', categoryId);
            if (searchQuery) params.append('search', searchQuery);
            if (params.toString()) url += `?${params.toString()}`;

            const rawMaterials = await fetchData(url);
            if (!rawMaterials) return;

            const rawMaterialListCardsContainer = document.getElementById('rawMaterialListCardsContainer');
            rawMaterialListCardsContainer.innerHTML = ''; // Clear existing cards

            if (rawMaterials.length > 0) {
                rawMaterials.forEach(material => {
                    const card = document.createElement('div');
                    card.classList.add('raw-material-item-card');
                    card.innerHTML = `
                        <div class="info">
                            <h3>${material.name}</h3>
                            <div class="details">
                                <span class="tag ${getCategoryTagClass(material.category_name)}">${material.category_name || 'بدون دسته‌بندی'}</span> |
                                <span>واحد اندازه‌گیری: ${material.unit_of_measurement}</span> |
                                <span>موجودی فعلی: ${material.current_stock}</span> |
                                <span>تعداد غذاهای مرتبط: ${material.foods_related_count}</span>
                            </div>
                        </div>
                        <div class="actions">
                            <button class="edit-btn" data-raw-material-id="${material.id}"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-raw-material-id="${material.id}"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    rawMaterialListCardsContainer.appendChild(card);

                    // Add event listeners for edit and delete buttons
                    card.querySelector('.edit-btn').addEventListener('click', () => editRawMaterial(material.id));
                    card.querySelector('.delete-btn').addEventListener('click', () => deleteRawMaterial(material.id, material.name));
                });
            } else {
                rawMaterialListCardsContainer.innerHTML = '<p style="text-align: center;">هیچ ماده اولیه‌ای با این فیلترها یافت نشد.</p>';
            }
        }

        async function editRawMaterial(rawMaterialId) {
            alert(`ویرایش ماده اولیه با ID: ${rawMaterialId} (این قابلیت هنوز پیاده سازی نشده و نیاز به بارگذاری فرم با داده ها دارد)`);
            // In a real app:
            // 1. Fetch raw material details: await fetchData(`${BASE_API_URL}raw-materials/${rawMaterialId}/`);
            // 2. Populate the 'add-new-raw-material' form with these details.
            // 3. Change 'save' button to 'update' button logic.
            // 4. showSection('add-new-raw-material');
        }

        async function deleteRawMaterial(rawMaterialId, rawMaterialName) {
            if (confirm(`آیا از حذف ماده اولیه "${rawMaterialName}" مطمئن هستید؟`)) {
                const success = await deleteData(`${BASE_API_URL}raw-materials/${rawMaterialId}/`);
                if (success) {
                    alert(`ماده اولیه "${rawMaterialName}" با موفقیت حذف شد.`);
                    loadRawMaterialListData(); // Reload the list after deletion
                    loadDashboardData(); // Update dashboard stats as well
                }
            }
        }

        // --- Dashboard Charts (Raw Material Section) ---
        async function loadDashboardCharts() {
            const data = await fetchData(`${BASE_API_URL}dashboard-stats/`);
            if (!data) return;

            // Render Top Consumed Materials (same as dashboard, could be a shared function)
            const rawMaterialTopConsumedList = document.getElementById('rawMaterialTopConsumedList');
            rawMaterialTopConsumedList.innerHTML = '';
            if (data.top_consumed_materials) {
                const colors = ['#c8e6c9', '#ffccbc', '#fff9c4']; // Example colors
                data.top_consumed_materials.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.classList.add('material-item');
                    div.innerHTML = `
                        <div class="color-box" style="background-color: ${colors[index % colors.length]};"></div>
                        <div class="quantity">${item.total_needed} ${item.raw_material__unit_of_measurement}</div>
                        <div class="description">${item.raw_material__name} <small> (مقدار کل لازم در دستور پخت‌ها)</small></div>
                    `;
                    rawMaterialTopConsumedList.appendChild(div);
                });
            } else {
                rawMaterialTopConsumedList.innerHTML = '<p>اطلاعات مواد اولیه پرمصرف موجود نیست.</p>';
            }

            // Render Stock Status (same as dashboard)
            const rawMaterialStockStatusList = document.getElementById('rawMaterialStockStatusList');
            rawMaterialStockStatusList.innerHTML = '';
            if (data.stock_status) {
                data.stock_status.forEach(item => {
                    const div = document.createElement('div');
                    let progressColorClass = 'green';
                    if (item.percentage < 30) {
                        progressColorClass = 'red';
                    } else if (item.percentage < 70) {
                        progressColorClass = 'orange';
                    }
                    div.innerHTML = `
                        <div class="progress-text">
                            <span>${item.name}</span>
                            <span>${item.percentage}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar ${progressColorClass}" style="width: ${item.percentage}%;"></div>
                        </div>
                    `;
                    rawMaterialStockStatusList.appendChild(div);
                });
            } else {
                rawMaterialStockStatusList.innerHTML = '<p>اطلاعات وضعیت موجودی موجود نیست.</p>';
            }
        }

        // --- Form Population Functions (Categories, Sizes, Raw Materials) ---
        async function populateCategories(selectElementId, defaultOptionText = 'یک دسته‌بندی را انتخاب کنید') {
            const selectElement = document.getElementById(selectElementId);
            if (!selectElement) return;

            const categories = await fetchData(`${BASE_API_URL}categories/`);
            if (!categories) return;

            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = cat.name;
                selectElement.appendChild(option);
            });
        }

        async function populateFoodFormDropdowns() {
            await populateCategories('foodCategory', 'یک دسته‌بندی غذا را انتخاب کنید');
            await populateSizesForCheckboxes('foodSizeCheckboxes');
            await populateRawMaterialsForFoodForm();
        }

        async function populateRawMaterialFormDropdowns() {
            await populateCategories('rawMaterialCategory', 'یک دسته‌بندی ماده اولیه را انتخاب کنید');
            // Unit dropdown is static, no need to fetch
        }

        async function populateSizesForCheckboxes(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const sizes = await fetchData(`${BASE_API_URL}size-options/`);
            if (!sizes) return;

            container.innerHTML = ''; // Clear existing checkboxes
            sizes.forEach(size => {
                const label = document.createElement('label');
                label.innerHTML = `<input type="checkbox" name="foodSize" value="${size.id}"> ${size.name}`;
                container.appendChild(label);
            });
        }

        async function populateRawMaterialsForFoodForm() {
            // This function populates the dropdowns for raw materials when adding a new one to a food
            // It gets all available raw materials from the API
            const rawMaterials = await fetchData(`${BASE_API_URL}raw-materials/`);
            if (!rawMaterials) return;

            // Store raw materials globally or pass around if needed for dynamic updates
            window.allRawMaterials = rawMaterials;
        }

        // --- Event Listeners and Form Submission Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial section display (will also trigger data load)
            showSection('dashboard');

            // Add event listeners for sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.currentTarget.dataset.section;
                    showSection(sectionId);
                });
            });

            // --- Food List Filters ---
            const foodListCategoryFilter = document.getElementById('foodListCategoryFilter');
            const foodListSearchInput = document.getElementById('foodListSearchInput');

            if (foodListCategoryFilter) {
                populateCategories('foodListCategoryFilter', 'همه دسته‌بندی‌ها');
                foodListCategoryFilter.addEventListener('change', () => {
                    loadFoodListData(foodListCategoryFilter.value, foodListSearchInput.value);
                });
            }
            if (foodListSearchInput) {
                foodListSearchInput.addEventListener('input', () => {
                    loadFoodListData(foodListCategoryFilter.value, foodListSearchInput.value);
                });
            }


            // --- Raw Material List Filters ---
            const rawMaterialListCategoryFilter = document.getElementById('rawMaterialListCategoryFilter');
            const rawMaterialListSearchInput = document.getElementById('rawMaterialListSearchInput');

            if (rawMaterialListCategoryFilter) {
                populateCategories('rawMaterialListCategoryFilter', 'فیلتر دسته‌بندی');
                rawMaterialListCategoryFilter.addEventListener('change', () => {
                    loadRawMaterialListData(rawMaterialListCategoryFilter.value, rawMaterialListSearchInput.value);
                });
            }
            if (rawMaterialListSearchInput) {
                rawMaterialListSearchInput.addEventListener('input', () => {
                    loadRawMaterialListData(rawMaterialListCategoryFilter.value, rawMaterialListSearchInput.value);
                });
            }


            // --- Add New Food Form Logic ---
            const addFoodMaterialBtn = document.getElementById('addFoodMaterialBtn');
            const foodMaterialsList = document.getElementById('foodMaterialsList');
            const saveFoodBtn = document.getElementById('saveFoodBtn');

            if (addFoodMaterialBtn && foodMaterialsList) {
                addFoodMaterialBtn.addEventListener('click', () => {
                    const newMaterialRow = document.createElement('div');
                    newMaterialRow.classList.add('material-row');
                    newMaterialRow.innerHTML = `
                        <div>
                            <label>نام ماده اولیه</label>
                            <select class="raw-material-select" required>
                                <option value="">انتخاب کنید...</option>
                            </select>
                        </div>
                        <div>
                            <label>مقدار</label>
                            <input type="number" step="0.01" min="0" value="0" required>
                        </div>
                        <div>
                            <label>واحد</label>
                            <select class="raw-material-unit-display" disabled>
                                <option value="">واحد</option>
                            </select>
                        </div>
                        <div>
                            <label>توضیحات</label>
                            <input type="text" placeholder="توضیحات اضافی...">
                        </div>
                        <div class="actions">
                            <button type="button" class="delete-material-btn"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    foodMaterialsList.appendChild(newMaterialRow);

                    // Populate the new raw material dropdown
                    const select = newMaterialRow.querySelector('.raw-material-select');
                    const unitDisplay = newMaterialRow.querySelector('.raw-material-unit-display');
                    if (window.allRawMaterials) {
                        window.allRawMaterials.forEach(rm => {
                            const option = document.createElement('option');
                            option.value = rm.id; // Use ID for backend
                            option.textContent = rm.name;
                            select.appendChild(option);
                        });
                    }

                    // Update unit display when raw material changes
                    select.addEventListener('change', (e) => {
                        const selectedRawMaterialId = e.target.value;
                        const selectedRawMaterial = window.allRawMaterials.find(rm => rm.id == selectedRawMaterialId);
                        if (selectedRawMaterial) {
                            unitDisplay.innerHTML = `<option value="${selectedRawMaterial.unit_of_measurement}">${selectedRawMaterial.unit_of_measurement}</option>`;
                        } else {
                            unitDisplay.innerHTML = `<option value="">واحد</option>`;
                        }
                    });

                    // Add event listener to the new delete button
                    newMaterialRow.querySelector('.delete-material-btn').addEventListener('click', (e) => {
                        e.currentTarget.closest('.material-row').remove();
                    });
                });
            }

            if (saveFoodBtn) {
                saveFoodBtn.addEventListener('click', async () => {
                    const foodName = document.getElementById('foodName').value;
                    const foodCategory = document.getElementById('foodCategory').value;
                    const foodDescription = document.getElementById('foodDescription').value;

                    const selectedSizes = Array.from(document.querySelectorAll('#foodSizeCheckboxes input[name="foodSize"]:checked'))
                                            .map(cb => parseInt(cb.value)); // Get IDs as integers

                    const foodRawMaterials = [];
                    document.querySelectorAll('#foodMaterialsList .material-row').forEach(row => {
                        const rawMaterialId = row.querySelector('.raw-material-select').value;
                        const quantityNeeded = parseFloat(row.querySelector('input[type="number"]').value);
                        const notes = row.querySelector('input[type="text"]').value;

                        if (rawMaterialId && quantityNeeded > 0) {
                            foodRawMaterials.push({
                                raw_material: parseInt(rawMaterialId),
                                quantity_needed: quantityNeeded,
                                notes: notes
                            });
                        }
                    });

                    if (!foodName || !foodCategory || selectedSizes.length === 0 || foodRawMaterials.length === 0) {
                        alert('لطفاً تمام فیلدهای اجباری (نام غذا، دسته‌بندی، حداقل یک سایز و حداقل یک ماده اولیه) را پر کنید.');
                        return;
                    }

                    const newFoodData = {
                        name: foodName,
                        category: parseInt(foodCategory),
                        description: foodDescription,
                        available_sizes: selectedSizes,
                        food_raw_materials: foodRawMaterials
                    };

                    const result = await postData(`${BASE_API_URL}foods/`, newFoodData);
                    if (result) {
                        alert('غذای جدید با موفقیت ذخیره شد!');
                        // Clear form or navigate
                        document.getElementById('foodName').value = '';
                        document.getElementById('foodCategory').value = ''; // Reset dropdown
                        document.getElementById('foodDescription').value = '';
                        document.querySelectorAll('#foodSizeCheckboxes input[name="foodSize"]:checked').forEach(cb => cb.checked = false);
                        document.getElementById('foodMaterialsList').innerHTML = ''; // Clear raw materials list
                        showSection('food-list'); // Go back to food list
                    }
                });
            }


            // --- Add New Raw Material Form Logic ---
            const saveRawMaterialBtn = document.getElementById('saveRawMaterialBtn');
            if (saveRawMaterialBtn) {
                saveRawMaterialBtn.addEventListener('click', async () => {
                    const rawMaterialName = document.getElementById('rawMaterialName').value;
                    const rawMaterialCategory = document.getElementById('rawMaterialCategory').value;
                    const rawMaterialUnit = document.getElementById('rawMaterialUnit').value;
                    const rawMaterialStock = parseFloat(document.getElementById('rawMaterialStock').value);
                    const rawMaterialDescription = document.getElementById('rawMaterialDescription').value;

                    if (!rawMaterialName || !rawMaterialCategory || !rawMaterialUnit || isNaN(rawMaterialStock)) {
                        alert('لطفاً تمام فیلدهای اجباری را پر کنید.');
                        return;
                    }

                    const newRawMaterialData = {
                        name: rawMaterialName,
                        category: parseInt(rawMaterialCategory),
                        unit_of_measurement: rawMaterialUnit,
                        current_stock: rawMaterialStock,
                        description: rawMaterialDescription
                    };

                    const result = await postData(`${BASE_API_URL}raw-materials/`, newRawMaterialData);
                    if (result) {
                        alert('ماده اولیه جدید با موفقیت ذخیره شد!');
                        // Clear form or navigate
                        document.getElementById('rawMaterialName').value = '';
                        document.getElementById('rawMaterialCategory').value = '';
                        document.getElementById('rawMaterialUnit').value = 'gram';
                        document.getElementById('rawMaterialStock').value = '0';
                        document.getElementById('rawMaterialDescription').value = '';
                        showSection('raw-material-management'); // Go back to raw material list
                    }
                });
            }
        });

        // --- Helper for Tag Classes (as you have custom classes for tags) ---
        function getCategoryTagClass(categoryName) {
            const lowerCaseName = categoryName ? categoryName.toLowerCase() : '';
            if (lowerCaseName.includes('ایرانی')) return 'iranian';
            if (lowerCaseName.includes('خورشت')) return 'stew';
            if (lowerCaseName.includes('پروتئین')) return 'protein';
            if (lowerCaseName.includes('غلات')) return 'grains';
            if (lowerCaseName.includes('روغن') || lowerCaseName.includes('چربی')) return 'oil';
            if (lowerCaseName.includes('سبزیجات')) return 'vegetables';
            if (lowerCaseName.includes('ادویه')) return 'spices';
            return ''; // Default or no special class
        }
    </script>
</body>
</html>